<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Divine Forge - Refined Edition (Patched)</title>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #1a1a1a; color: #eee; user-select: none; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        h1, h2 { text-align: center; color: #f1c40f; margin-bottom: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        
        .main-layout { display: flex; gap: 25px; align-items: flex-start; position: relative; }
        .left-panel { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 20px; }
        .right-panel { width: 340px; flex-shrink: 0; position: sticky; top: 20px; z-index: 100; }
        
        .section { padding: 20px; border-radius: 8px; background: #2c2c2c; border: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        body.p1-turn .section { border-left: 5px solid #e74c3c; }
        body.p2-turn .section { border-left: 5px solid #3498db; }
        body.p3-turn .section { border-left: 5px solid #2ecc71; }
        body.p4-turn .section { border-left: 5px solid #f1c40f; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #555; padding-bottom: 10px; }
        
        /* --- ë§µ & ì‹œê³„ --- */
        .map-section { display: flex; flex-direction: column; align-items: center; padding: 20px; background: #222; border-radius: 15px; border: 2px solid #555; position: relative; }
        .clock-container { position: relative; width: 280px; height: 280px; border-radius: 50%; background: #333; border: 8px solid #555; box-shadow: inset 0 0 30px rgba(0,0,0,0.8), 0 5px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }
        .clock-face { position: absolute; width: 85%; height: 85%; border-radius: 50%; border: 2px dashed #666; box-sizing: border-box; }
        .clock-center-point { position: absolute; width: 12px; height: 12px; background: #aaa; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; }
        .map-tile { position: absolute; width: 28px; height: 28px; background: #444; border: 2px solid #777; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #aaa; font-size: 12px; transform: translate(-50%, -50%); z-index: 10; }
        .map-tile.start-point { border-color: #f1c40f; color: #fff; background: #554400; box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        
        .player-piece { position: absolute; width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; color: white; text-shadow: 0 1px 2px #000; z-index: 20; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); transform: translate(-50%, -50%); box-shadow: 0 4px 6px rgba(0,0,0,0.6); }
        .player-piece.active-turn { width: 40px; height: 40px; font-size: 16px; border: 3px solid #fff; z-index: 100 !important; transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
        .piece-p1 { background-color: #e74c3c; } .piece-p2 { background-color: #3498db; } .piece-p3 { background-color: #2ecc71; } .piece-p4 { background-color: #f1c40f; }

        /* --- ì¹´ë“œ ë° ì‹œì¥ --- */
        .market-container { display: flex; align-items: center; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .deck-area { flex-shrink: 0; padding-right: 15px; border-right: 2px dashed #555; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .card-list { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-start; }
        
        .hand-area { min-height: 140px; background: #222; border: 2px dashed #555; border-radius: 10px; padding: 10px; display: flex; gap: 5px; overflow-x: auto; align-items: center; }
        .hand-area.drag-over { background: #333; border-color: #f1c40f; }
        
        .reserved-area { min-height: 140px; background: #252222; border: 2px solid #5d4037; border-radius: 10px; padding: 10px; display: flex; gap: 5px; overflow-x: auto; align-items: center; }
        
        .artifacts-wrapper { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .player-artifact-row { display: flex; align-items: center; gap: 10px; background: #222; padding: 8px; border-radius: 8px; border-left: 5px solid #555; min-height: 140px; overflow-x: auto; }
        .player-label { min-width: 60px; font-weight: bold; text-align: center; color: #aaa; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 12px; }
        .p1-row { border-color: #e74c3c; background: rgba(231, 76, 60, 0.05); } .p2-row { border-color: #3498db; background: rgba(52, 152, 219, 0.05); } .p3-row { border-color: #2ecc71; background: rgba(46, 204, 113, 0.05); } .p4-row { border-color: #f1c40f; background: rgba(241, 196, 15, 0.05); }
        .artifact-list-container { display: flex; gap: 5px; flex: 1; overflow-x: auto; align-items: center; }

        .empty-slot { width: 80px; height: 116px; border: 2px dashed #444; border-radius: 8px; display: flex; justify-content: center; align-items: center; color: #555; font-size: 11px; flex-shrink: 0; }
        
/* [ìˆ˜ì •] ì¹´ë“œ ë Œë”ë§ ìµœì í™”: will-change ì¶”ê°€ */
        .card { 
            width: 80px; height: 116px; border-radius: 6px; flex-shrink: 0; 
            background-color: #111; background-size: cover; background-position: center; 
            border: 2px solid #555; cursor: pointer; position: relative; 
            transition: transform 0.2s, box-shadow 0.2s; 
            will-change: transform; /* í•µì‹¬: GPU ê°€ì† íŒíŠ¸ */
        }
        
        /* [ìˆ˜ì •] íˆ´íŒ ë Œë”ë§ ìµœì í™”: will-change ì¶”ê°€ */
        #global-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            color: #e040fb;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            white-space: pre-wrap;
            z-index: 10000;
            pointer-events: none;
            border: 1px solid #9c27b0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: none;
            min-width: 150px;
            max-width: 250px;
            text-align: center;
            backdrop-filter: blur(4px);
            will-change: left, top; /* í•µì‹¬: ìœ„ì¹˜ ë³€ê²½ ìµœì í™” */
        }

        .card.artifact { width: 100px; height: 160px; border: 2px solid #777; background-color: #1a1a1a; display:flex; flex-direction:column; }
        
        @keyframes medalShine {
            0% { box-shadow: 0 0 5px rgba(255,255,255,0.5); transform: scale(1); filter: brightness(1); }
            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.9); transform: scale(1.15); filter: brightness(1.3); }
            100% { box-shadow: 0 0 5px rgba(255,255,255,0.5); transform: scale(1); filter: brightness(1); }
        }
        .medal-icon { position: absolute; top: -8px; right: -8px; width: 30px; height: 30px; background-size: cover; border-radius: 50%; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.5); background-color: #333; border: 2px solid #fff; display: flex; justify-content: center; align-items: center; font-size: 8px; color: #333; font-weight: bold; }
        .medal-icon.shining { animation: medalShine 2s infinite ease-in-out; border-color: #ffd700; }
        
        .medal-Gold { background-image: url('images/medal_gold.png'); background-color: #ffd700; } 
        .medal-Silver { background-image: url('images/medal_silver.png'); background-color: #c0c0c0; } 
        .medal-Bronze { background-image: url('images/medal_bronze.png'); background-color: #cd7f32; }

        .artifact-info { padding: 4px; width: 100%; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; background: rgba(0,0,0,0.85); border-radius: 4px; }
        .art-type { font-size: 9px; font-weight: bold; text-align: center; margin-bottom: 2px; padding: 2px; border-radius: 3px; color: #111; }
        .art-name { font-size: 10px; font-weight: bold; text-align: center; color: #fff; margin-bottom: 2px; word-break: keep-all; line-height: 1.1; flex:1; display:flex; align-items:center; justify-content:center;}
        .art-score { font-size: 11px; font-weight: bold; color: #f1c40f; text-align: center; border-bottom: 1px solid #555; padding-bottom: 2px; margin-bottom: 2px; }
        .req-row { display: flex; justify-content: space-between; align-items: center; font-size: 9px; color: #ddd; border-bottom: 1px dashed #444; padding-bottom: 1px; }
        .req-val { color: #fff; font-weight: bold; font-size: 10px; }
        .reserved-badge { position: absolute; top: 0; left: 0; width: 100%; background: rgba(50, 50, 200, 0.8); color: white; font-size: 10px; text-align: center; padding: 2px 0; font-weight: bold; }

        .card-scale-down { transform: scale(0.9); transform-origin: top left; margin-right: -10px; margin-bottom: -15px; }

        .btn { padding: 5px 10px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn:hover { background: #2ecc71; transform: translateY(-1px); }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-next { background-color: #27ae60 !important; box-shadow: 0 0 10px rgba(39, 174, 96, 0.5); width: 100%; padding: 10px; font-size: 14px;}
        .log { background: #000; color: #0f0; padding: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #444; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: #333; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #f1c40f; box-shadow: 0 0 30px rgba(0,0,0,0.8); min-width: 600px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .modal-btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .modal-btn { padding: 10px 20px; font-size: 16px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; color: white; }
        .btn-craft { background: #27ae60; } .btn-reserve { background: #2980b9; } .btn-cancel { background: #c0392b; }

        .turn-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 3000; animation: fadeIn 0.3s; pointer-events: none; }
        .turn-title { font-size: 4em; font-weight: bold; margin-bottom: 20px; text-shadow: 0 0 20px #000; background: rgba(0,0,0,0.7); padding: 20px 40px; border-radius: 20px; border: 2px solid #fff; }
        
        .day-end-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; display: none; justify-content: center; align-items: center; z-index: 4000; animation: fadeInOut 1.5s forwards; pointer-events: none; }
        @keyframes fadeInOut { 0% { opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
        
        .night-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(180deg, #1a0033 0%, #000 100%); display: none; flex-direction: column; align-items: center; z-index: 2500; overflow-y: auto; padding: 20px; }
        .night-dashboard { width: 90%; max-width: 1000px; background: #222; border: 1px solid #555; border-radius: 10px; padding: 15px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .night-dash-row { display: flex; gap: 15px; align-items: center; }
        .night-dash-label { width: 100px; font-weight: bold; color: #aaa; font-size: 14px; text-align: right; }
        .night-dash-content { flex: 1; display: flex; gap: 5px; overflow-x: auto; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 5px; min-height: 60px; align-items: center; }
        
        .loki-market { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .loki-slot { width: 160px; height: 240px; border: 2px dashed #9c27b0; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; background-size: cover; background-position: center; background-color: rgba(0,0,0,0.3); transition: transform 0.2s; cursor: pointer; }
        .loki-slot:hover { transform: scale(1.05); border-color: white; z-index: 10; box-shadow: 0 0 20px #e040fb; }
        .loki-slot.selected { border: 3px solid #00e676; box-shadow: 0 0 20px #00e676; transform: scale(1.05); }
        .loki-slot.conflict { border: 3px solid #e74c3c; box-shadow: 0 0 20px #e74c3c; filter: grayscale(100%); opacity: 0.7; }
        .loki-slot.conflict::after { content: "ğŸ’¥ì¶©ëŒ"; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(-15deg); font-size: 2em; font-weight:bold; color:#e74c3c; border: 3px solid #e74c3c; padding: 5px; background: rgba(0,0,0,0.8); }
        .loki-result-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #fff; padding: 5px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .loki-slot-num { position: absolute; top: -15px; left: -15px; width: 40px; height: 40px; background: #e040fb; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2em; box-shadow: 0 0 10px #e040fb; }

        .card.market-selected { border-color: #00e676; box-shadow: 0 0 15px #00e676; transform: translateY(-10px); }
        .card.swap-target { border: 3px solid #e040fb !important; box-shadow: 0 0 15px #e040fb; transform: scale(1.05); }
        .card.swap-select { border: 3px solid #f39c12 !important; box-shadow: 0 0 15px #f39c12; transform: translateY(-10px); }
        
        .flying-card { position: fixed; z-index: 9999; transition: all 0.6s ease-in-out; pointer-events: none; box-shadow: 0 0 20px rgba(255, 255, 255, 0.8); border: 2px solid #fff; }
        
        .nord-panel { background: rgba(46, 204, 113, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #2ecc71; display: none; justify-content: space-between; align-items: center; }
        
        .crafting-container { display: flex; gap: 20px; align-items: flex-start; justify-content: center; }
        .crafting-workspace { flex: 1; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #555; }
        .select-zone { min-height: 120px; border: 2px dashed #777; border-radius: 8px; padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; align-items: center; background: #2a2a2a; }
        .select-zone-label { width: 100%; text-align: center; color: #777; font-size: 12px; margin-bottom: 5px; }
        .my-hand-grid { display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; background: #1a1a1a; border-radius: 8px; min-height: 100px; }
        .card.selected { opacity: 0.3; filter: grayscale(100%); pointer-events: none; }
        .card.in-slot { width: 60px; height: 87px; cursor: pointer; box-shadow: 0 0 10px gold; border-color: gold; }
        
        .craft-status { margin-top: 10px; padding: 10px; background: #333; border-radius: 5px; font-size: 13px; color: #ddd; text-align: left; }
        .status-ok { color: #2ecc71; font-weight: bold; } .status-fail { color: #e74c3c; font-weight: bold; }
        .olympus-discount { background: #003366; padding: 10px; border-radius: 5px; margin-bottom: 10px; text-align: left; border: 1px solid #00bfff; }
        
        .dev-fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #c0392b; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; z-index: 5000; border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.6); }
        .dev-fab:hover { transform: scale(1.1); }
        .dev-menu { position: fixed; bottom: 90px; right: 20px; background: #333; border: 2px solid #f1c40f; padding: 15px; border-radius: 10px; display: none; z-index: 4999; width: 200px; }
        .dev-btn { display: block; width: 100%; margin-bottom: 8px; padding: 8px; background: #555; color: white; border: none; text-align: left; cursor: pointer; font-weight: bold; }
        .dev-btn:hover { background: #777; }
        .dev-active { background: #27ae60 !important; }
        .dev-search-input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; background: #444; border: 1px solid #777; color: white; }
        
        .btn-settings { position: fixed; bottom: 20px; right: 90px; width: 50px; height: 50px; border-radius: 50%; background: #333; border: 2px solid #777; font-size: 24px; cursor: pointer; z-index: 5000; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: transform 0.2s; }
        .btn-settings:hover { transform: rotate(45deg); border-color: #f1c40f; color: #f1c40f; }
        .settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 6000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .settings-content { background: #2c2c2c; padding: 30px; border-radius: 12px; border: 2px solid #f1c40f; width: 300px; box-shadow: 0 0 20px rgba(241, 196, 15, 0.2); text-align: center; color: #eee; }
        .volume-control { margin: 20px 0; display: flex; flex-direction: column; gap: 10px; }
        .volume-label { display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; color: #aaa; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #f1c40f; cursor: pointer; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #555; border-radius: 2px; }
        input[type=range]:focus { outline: none; }

        /* [NEW] Game End Modal Styles */
        .rank-row { display: flex; align-items: center; background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .rank-num { font-size: 24px; font-weight: bold; margin-right: 15px; width: 30px; }
        .rank-p1 { color: #e74c3c; border-color: #e74c3c; }
        .rank-p2 { color: #3498db; border-color: #3498db; }
        .rank-p3 { color: #2ecc71; border-color: #2ecc71; }
        .rank-p4 { color: #f1c40f; border-color: #f1c40f; }
/* [ìˆ˜ì • v10.1] ì‹ í™”ë³„ ìœ ë¬¼ í…Œë‘ë¦¬ ìƒ‰ìƒ (ë§¨ ì•„ë˜ì— ë‘ì–´ ìµœìš°ì„  ì ìš©) */
        .card.type-egypt { border-color: #ffd700 !important; box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); } 
        .card.type-nord { border-color: #9b59b6 !important; box-shadow: 0 0 10px rgba(155, 89, 182, 0.6); } 
        .card.type-olympus { border-color: #00bfff !important; box-shadow: 0 0 10px rgba(0, 191, 255, 0.6); } 
        .card.type-celt { border-color: #2ecc71 !important; box-shadow: 0 0 10px rgba(46, 204, 113, 0.6); } 
        .card.type-loki { border-color: #9c27b0 !important; width: 100px; height: 145px; box-shadow: 0 0 12px rgba(156, 39, 176, 0.5); }
    </style>
</head>
<body>

<div id="audioAssets" style="display:none;">
    <audio id="bgmAudio" src="sounds/bgm.mp3" loop></audio> 
    <audio id="sfxHover" src="sounds/card_hover.mp3"></audio>
    <audio id="sfxSelect" src="sounds/card_select.mp3"></audio>
    <audio id="sfxTurnStart" src="sounds/turn_start.mp3"></audio>
</div>
<div class="btn-settings" style="bottom: 80px; font-size: 20px;" onclick="document.getElementById('abilityModal').style.display='flex'">ğŸ“–</div>

<div id="abilityModal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content" style="max-width: 600px; text-align: left;">
        <h2 style="color:#f1c40f; text-align:center; margin-bottom:20px;">ğŸ“œ ì‹ í™” ëŠ¥ë ¥ ì°¸ì¡°í‘œ</h2>
        
        <div style="margin-bottom: 15px; padding:10px; border:1px solid #2ecc71; background:rgba(46, 204, 113, 0.1); border-radius:8px;">
            <h3 style="color:#2ecc71; margin:0 0 5px;">â„ï¸ ë…¸ë¥´ë“œ (Nord)</h3>
            <p style="font-size:13px; color:#ddd; margin:0;">
                ì‹œì¥ì˜ ìì› ì¹´ë“œë“¤ì˜ ìˆ˜ì¹˜ í•©ì´ <b>íŠ¹ì • ê°’ ì´í•˜</b>ì¼ ë•Œ,<br>
                í–‰ë™ 1íšŒ(3H)ë¡œ ì—¬ëŸ¬ ì¥ì„ í•œ ë²ˆì— ê°€ì ¸ì˜µë‹ˆë‹¤.<br>
                - 1ë‹¨ê³„: í•© <b>6</b> ì´í•˜ (ìµœëŒ€ 2ì¥)<br>
                - 2ë‹¨ê³„: í•© <b>9</b> ì´í•˜ (ìµœëŒ€ 2ì¥)<br>
                - 3ë‹¨ê³„: í•© <b>14</b> ì´í•˜ (ìµœëŒ€ 3ì¥)
            </p>
        </div>

        <div style="margin-bottom: 15px; padding:10px; border:1px solid #ffd700; background:rgba(255, 215, 0, 0.1); border-radius:8px;">
            <h3 style="color:#ffd700; margin:0 0 5px;">ğŸ‘ï¸ ì´ì§‘íŠ¸ (Egypt)</h3>
            <p style="font-size:13px; color:#ddd; margin:0;">
                íŠ¹ì • í–‰ë™ì˜ <b>ì‹œê°„ ë¹„ìš©(H)</b>ì„ ì¤„ì—¬ì¤ë‹ˆë‹¤.<br>
                - 1ë‹¨ê³„: ìœ ë¬¼ ë³´ê´€ ë¹„ìš© -1H <br>
                - 2ë‹¨ê³„: ë³´ê´€, ìì› ë¹„ìš© -1H <br>
                - 3ë‹¨ê³„:ë³´ê´€,ìì›,ì¶•ë³µ,ì œì‘ ë¹„ìš© -1H 
            </p>
        </div>

        <div style="margin-bottom: 15px; padding:10px; border:1px solid #00bfff; background:rgba(0, 191, 255, 0.1); border-radius:8px;">
            <h3 style="color:#00bfff; margin:0 0 5px;">â˜ï¸ ì˜¬ë¦¼í¬ìŠ¤ (Olympus)</h3>
            <p style="font-size:13px; color:#ddd; margin:0;">
                ìœ ë¬¼ ì œì‘ ì‹œ, <b>ì¬ë£Œ 1ì¢…ë¥˜ì˜ ìš”êµ¬ëŸ‰</b>ì„ í• ì¸í•©ë‹ˆë‹¤.<br>
                - 1ë‹¨ê³„: ì¬ë£Œ <b>2ê°œ</b> í• ì¸<br>
                - 2ë‹¨ê³„: ì¬ë£Œ <b>5ê°œ</b> í• ì¸<br>
                - 3ë‹¨ê³„: ì¬ë£Œ <b>12ê°œ</b> í• ì¸
            </p>
        </div>

        <div style="margin-bottom: 15px; padding:10px; border:1px solid #2ecc71; background:rgba(46, 204, 113, 0.1); border-radius:8px; border-color:#27ae60;">
            <h3 style="color:#27ae60; margin:0 0 5px;">â˜˜ï¸ ì¼ˆíŠ¸ (Celt)</h3>
            <p style="font-size:13px; color:#ddd; margin:0;">
                ì œì‘ ì‹œ ë¶€ì¡±í•œ ì¬ë£Œë¥¼ <b>ë‹¤ë¥¸ ìì› ì¹´ë“œë¡œ ëŒ€ì²´</b>í•©ë‹ˆë‹¤.<br>
                - 1ë‹¨ê³„: ì¹´ë“œ <b>1ì¥</b> ëŒ€ì²´<br>
                - 2ë‹¨ê³„: ì¹´ë“œ <b>2ì¥</b> ëŒ€ì²´ + ì¶•ë³µ ì¡°ê±´ì„ ë‹¤ë¥¸ ì¶•ë³µìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥<br>
                - 3ë‹¨ê³„: ì¹´ë“œ <b>3ì¥</b> ëŒ€ì²´ + <b>ì¶•ë³µ ì¡°ê±´ ë©´ì œ</b> + íƒ€ ì‹ í™” ëŠ¥ë ¥ ëª¨ë°© ê°€ëŠ¥
            </p>
        </div>

        <div class="modal-btn-group">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('abilityModal').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>
</div>
<div class="btn-settings" onclick="audioManager.openSettings()">âš™ï¸</div>

<div id="settingsModal" class="settings-modal">
    <div class="settings-content">
        <h2 style="color:#f1c40f; margin-bottom:20px;">ğŸ”Š Audio Settings</h2>
        <div class="volume-control">
            <div class="volume-label"><span>BGM (ë°°ê²½ìŒì•…)</span><span id="bgmVal">50%</span></div>
            <input type="range" id="bgmSlider" min="0" max="1" step="0.01" value="0.5" oninput="audioManager.setBgmVolume(this.value)">
        </div>
        <div class="volume-control">
            <div class="volume-label"><span>SFX (íš¨ê³¼ìŒ)</span><span id="sfxVal">50%</span></div>
            <input type="range" id="sfxSlider" min="0" max="1" step="0.01" value="0.5" oninput="audioManager.setSfxVolume(this.value)">
        </div>
        <button class="modal-btn btn-craft" style="width:100%; margin-top:20px;" onclick="audioManager.closeSettings()">ë‹«ê¸°</button>
    </div>
</div>

<div id="startModal" class="modal" style="display:flex; background:rgba(0,0,0,1);">
    <div class="modal-content" style="max-width:500px; border-color:#9b59b6;">
        <h1 style="color:#9b59b6; text-shadow:0 0 10px #9b59b6;">ğŸŒŒ Constellation Mode</h1>
        <p style="color:#ddd; margin-bottom:30px;">ë³„ìë¦¬ ì¹´ë“œëŠ” ê²Œì„ ì „ì²´ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” íŠ¹ìˆ˜ ê·œì¹™ì…ë‹ˆë‹¤.<br>ë§¤ ê²Œì„ ë¬´ì‘ìœ„ë¡œ í•˜ë‚˜ì˜ ë³„ìë¦¬ê°€ ì„ ì •ë©ë‹ˆë‹¤.</p>
        <div class="modal-btn-group" style="flex-direction:column; gap:15px;">
            <button class="modal-btn" style="background:#555;" onclick="game.startGame(false)">ê¸°ë³¸ ëª¨ë“œ ì‹œì‘</button>
            <button class="modal-btn" style="background:linear-gradient(45deg, #8e44ad, #3498db); box-shadow:0 0 15px #8e44ad;" onclick="game.startGame(true)">âœ¨ ë³„ìë¦¬ ëª¨ë“œ ì‹œì‘</button>
<button class="modal-btn" style="background:#e74c3c; margin-top:10px; box-shadow:0 0 15px #c0392b;" onclick="game.startTestMode(13)">ğŸ ì—¼ì†Œìë¦¬ í…ŒìŠ¤íŠ¸ ëª¨ë“œ</button>
        </div>
    </div>
</div>

<div id="futureDiaryModal" class="modal">
    <div class="modal-content">
        <h2>ğŸ”® ë¯¸ë˜ ì¼ê¸°</h2>
        <p>ìœ ë¬¼ ë± ìœ„ 3ì¥ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. 1ì¥ì„ ì„ íƒí•˜ì—¬ ë³´ê´€í•˜ì„¸ìš”.</p>
        <div id="futureDiaryList" class="card-list" style="justify-content:center; margin:20px 0;"></div>
        <div class="modal-btn-group">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('futureDiaryModal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="gameEndModal" class="modal">
    <div class="modal-content" style="min-width: 500px;">
        <h1>ğŸ† ê²Œì„ ì¢…ë£Œ ğŸ†</h1>
        <div id="rankingContainer" style="text-align: left; padding: 20px;"></div>
        <button class="modal-btn btn-next" onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
</div>

<div class="container" id="mainGame">
    <h1>âš’ï¸ Divine Forge <span id="titleDevMode" style="display:none; color:#e74c3c; font-size:0.5em;">(DEV)</span></h1>
    <div class="main-layout">
        <div class="left-panel">
            <div class="section">
                <div class="header">
                    <span id="playerInfo" style="font-weight:bold; color:#e74c3c;">Player 1 Turn</span>
                    <span id="scoreInfo" style="color:#f1c40f; font-weight:bold;">ì ìˆ˜: 0</span>
                    <span id="handInfo">Hand: 0/8</span>
                </div>
                <div id="constellationBanner" class="section" style="display:none; border-left: 5px solid #9b59b6; background: linear-gradient(90deg, #2c2c2c 0%, #1a0b2e 100%); margin-bottom:15px; padding:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="font-size:24px;">ğŸŒŒ</div>
                            <div><div style="font-size:10px; color:#aaa;">ACTIVE CONSTELLATION</div><div id="constellationName" style="font-size:16px; font-weight:bold; color:#e040fb;">-</div></div>
                        </div>
                        <div id="constellationDesc" style="font-size:11px; color:#ddd; text-align:right; max-width:60%;">íš¨ê³¼ ì„¤ëª…</div>
                    </div>
                    <div id="taurusInfo" style="display:none; font-size:11px; color:#f1c40f; margin-top:5px; text-align:right;">*í™©ì†Œìë¦¬ íš¨ê³¼: <span id="taurusTargetName"></span> ìˆ˜ì¹˜ +1</div>
                </div>
                <div style="display:flex; gap: 20px;">
                    <div style="flex: 2;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin: 0 0 5px; font-size: 14px; color: #aaa;">ğŸ–ï¸ ë³´ìœ  ì¬ë£Œ (P1)</h3>
                            <button id="btnToggleSwap" class="btn" style="display:none;">â‡„ ìˆœì„œ ë³€ê²½</button>
                        </div>
                        <div id="myHand" class="hand-area"></div>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 5px; font-size: 14px; color: #aaa;">ğŸ“¦ ë³´ê´€í•¨ (P1)</h3>
                        <div id="myReserved" class="reserved-area"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="header">
                    <span class="title" style="color:#d4af37;">âš”ï¸ ìœ ë¬¼ ì œì‘ì†Œ (ì œì‘ <span id="costArt">2</span>H / ë³´ê´€ <span id="costReserve">1</span>H)</span>
                    <span style="font-size:12px; color:#aaa;">*í•­ìƒ 7ì¥ ìœ ì§€</span>
                </div>
                <div class="market-container">
                    <div class="deck-area">
                        <span class="deck-label">ëœë¤</span>
                        <div id="deckArt" class="card deck" style="background-image: url('images/back_artifact.png');" onclick="game.reserveFromDeck()"></div>
                        <div class="deck-info" style="font-size:10px;">í´ë¦­: ëœë¤ ë³´ê´€(1H)</div>
                    </div>
                    <div id="marketArt" class="card-list" style="flex:1;"></div>
                </div>
            </div>
            
            <div class="section">
                <div class="header">
                    <span class="title" style="color:#e67e22;">â›ï¸ ìì› ì‹œì¥ (<span id="costRes">3</span>H)</span>
                    <button id="btnSwapRes" class="btn" onclick="game.swap('resource')">ğŸ”„ êµì²´ (1H)</button>
                </div>
                <div class="market-container">
                    <div class="deck-area">
                        <span class="deck-label">ëœë¤</span>
                        <div id="deckRes" class="card deck" onclick="game.drawFromDeck('resource')"></div>
                        <div class="deck-info"><span id="cntDeckRes">-</span>/<span id="cntDiscRes">-</span></div>
                    </div>
                    <div id="marketRes" class="card-list" style="flex-wrap: nowrap;"></div>
                </div>
                <div id="nordPanel" class="nord-panel" style="margin-top:10px;">
                    <div style="font-weight:bold; color:#fff;">â„ï¸ ë…¸ë¥´ë“œ ëŠ¥ë ¥ ë°œë™ì¤‘</div>
                    <div id="nordInfo" style="color:#eee; font-size:13px;">ì„ íƒ: 0ì¥ (í•©: 0)</div>
                    <div>
                        <button class="btn" style="background:#27ae60;" onclick="game.confirmNord()">í™•ì¸</button>
                        <button class="btn" style="background:#c0392b;" onclick="game.cancelNord()">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>

            <div id="celtPanel" style="display:none; background:rgba(46, 204, 113, 0.1); border:1px solid #2ecc71; padding:10px; margin-bottom: 20px; border-radius:8px;"></div>

            <div class="section">
                <div class="header">
                    <span class="title" style="color:#2980b9;">âœ¨ ì¶•ë³µ ì‹œì¥ (<span id="costBless">2</span>H)</span>
                    <button id="btnSwapBless" class="btn" onclick="game.swap('blessing')">ğŸ”„ êµì²´ (1H)</button>
                </div>
                <div class="market-container">
                      <div class="deck-area">
                        <span class="deck-label">ëœë¤</span>
                        <div id="deckBless" class="card deck" onclick="game.drawFromDeck('blessing')"></div>
                        <div class="deck-info"><span id="cntDeckBless">-</span>/<span id="cntDiscBless">-</span></div>
                    </div>
                    <div id="marketBless" class="card-list" style="flex-wrap: nowrap;"></div>
                </div>
            </div>
            
            <div class="section">
                <h3 style="margin: 0 0 10px; font-size: 14px; color: #888;">ğŸ† í”Œë ˆì´ì–´ë³„ ì œì‘ ìœ ë¬¼ í˜„í™©</h3>
                <div id="craftedList" class="artifacts-wrapper"></div>
            </div>
            <div id="gameLog" class="log"></div>
        </div>
        
        <div class="right-panel">
            <div class="map-section">
                <span id="dayInfo" style="font-size:24px; font-weight:bold; color:#f1c40f; margin-bottom:15px;">Day 1</span>
                <div class="clock-container" id="clockContainer">
                    <div class="clock-face"></div>
                    <div class="clock-center-point"></div>
                    <div id="mapTiles"></div>
                    <div id="pieceP1" class="player-piece piece-p1">P1</div>
                    <div id="pieceP2" class="player-piece piece-p2">P2</div>
                    <div id="pieceP3" class="player-piece piece-p3">P3</div>
                    <div id="pieceP4" class="player-piece piece-p4">P4</div>
                </div>
                <div style="width:100%; text-align:center; color:#aaa; font-size:12px; margin-bottom:5px;">ì´ì „ ë‚ ì˜ ì‹œê°„ ì´ˆê³¼ë¶„ì€<br>ë‹¤ìŒ ë‚ ë¡œ ì´ì›”ë©ë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>
</div>

<div id="turnOverlay" class="turn-overlay"><div id="turnTitle" class="turn-title">Player 1 Turn</div></div>
<div id="dayEndOverlay" class="day-end-overlay"><div style="font-size:4em; font-weight:bold; color:#f1c40f;">â˜€ï¸ ë‚® ì¢…ë£Œ</div></div>

<div id="craftModal" class="modal">
    <div class="modal-content">
        <h2>âš”ï¸ ìœ ë¬¼ ì œì‘</h2>
        <div class="crafting-container">
            <div class="crafting-target" id="craftTargetCard"></div>
            <div class="crafting-workspace">
                <div id="olympusOption" class="olympus-discount" style="display:none;">
                    <div style="color:#00bfff; font-weight:bold; font-size:13px; margin-bottom:5px;">â˜ï¸ ì˜¬ë¦¼í¬ìŠ¤ í• ì¸ (<span id="olympusVal">0</span>ê°œ ê°ì†Œ)</div>
                    <div class="olympus-options" id="olympusRadios"></div>
                </div>
                <div class="select-zone-label">â–¼ ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ì§€ë¶ˆ ìŠ¬ë¡¯ì— ì¶”ê°€í•˜ì„¸ìš”</div>
                <div id="paymentSlot" class="select-zone"></div>
                <div id="craftStatus" class="craft-status"></div>
                <hr style="border-color:#444; margin:10px 0;">
                <div style="font-size:12px; color:#aaa; text-align:left; margin-bottom:5px;">ë‚´ í•¸ë“œ:</div>
                <div id="craftHandGrid" class="my-hand-grid"></div>
            </div>
        </div>
        <div class="modal-btn-group">
            <button class="modal-btn btn-craft" onclick="game.executeCraft()">ğŸ› ï¸ ì œì‘ ì‹œë„</button>
            <button id="btnReserveInModal" class="modal-btn btn-reserve" onclick="game.confirmReserve()">ğŸ“¦ ë³´ê´€</button>
            <button class="modal-btn btn-cancel" onclick="game.closeCraftModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<div id="celtConvertModal" class="modal">
    <div class="modal-content">
        <h2 style="color:#2ecc71;">â˜˜ï¸ ì¼ˆíŠ¸ ë¬¼ì§ˆ ë³€í™˜</h2>
        <p>ë³€í™˜í•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”. (ìˆ˜ì¹˜ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)</p>
        <div id="celtTargetList" class="card-list" style="justify-content:center; margin:20px 0;"></div>
        <div class="modal-btn-group">
            <button class="modal-btn btn-cancel" onclick="game.closeCeltModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<div id="swapModal" class="modal">
    <div class="modal-content" style="min-width: 800px;">
        <h2>âš–ï¸ ë§ê°ì˜ ì£¼íŒ (ìœ ë¬¼ êµí™˜)</h2>
        <p style="color:#aaa; font-size:14px;">ë‚´ ë³´ê´€í•¨ì˜ ìœ ë¬¼ 1ê°œì™€ ì‹œì¥ì˜ ìœ ë¬¼ 1ê°œë¥¼ ì„ íƒí•˜ì—¬ êµí™˜í•©ë‹ˆë‹¤.</p>
        <div style="display:flex; gap:20px; justify-content:center; margin:20px 0;">
            <div style="flex:1; border:1px solid #555; padding:10px; border-radius:8px; background:#222;">
                <h3 style="color:#d4af37; border-bottom:1px solid #444; padding-bottom:5px;">ğŸ“¦ ë‚´ ë³´ê´€í•¨</h3>
                <div id="swapMyReserved" class="card-list" style="justify-content:center; min-height:120px;"></div>
            </div>
            <div style="display:flex; align-items:center;"><div style="font-size:30px;">â‡„</div></div>
            <div style="flex:1; border:1px solid #555; padding:10px; border-radius:8px; background:#222;">
                <h3 style="color:#e67e22; border-bottom:1px solid #444; padding-bottom:5px;">ğŸ›ï¸ ì‹œì¥ ìœ ë¬¼</h3>
                <div id="swapMarket" class="card-list" style="justify-content:center; min-height:120px;"></div>
            </div>
        </div>
        <div class="modal-btn-group">
            <button id="btnExecuteSwap" class="modal-btn btn-craft" disabled onclick="game.executeSwap()">ğŸ”„ êµí™˜ ì‹¤í–‰</button>
            <button class="modal-btn btn-cancel" onclick="game.closeSwapModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="devArtifactModal" class="modal">
    <div class="modal-content" style="min-width: 800px; max-height:80vh;">
        <h2>ğŸ” ìœ ë¬¼ ê²€ìƒ‰ ë° ê°•ì œ ì œì‘</h2>
        <input type="text" id="devSearchInput" class="dev-search-input" placeholder="ìœ ë¬¼ ì´ë¦„ ê²€ìƒ‰..." onkeyup="game.filterDevArtifacts()">
        <div id="devArtifactList" class="card-list" style="justify-content:center; overflow-y:auto; flex:1;"></div>
        <div class="modal-btn-group">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('devArtifactModal').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="nightScreen" class="night-overlay">
    <div class="night-title">ğŸŒ™ Loki's Secret Deal</div>
    <div class="night-dashboard">
        <div class="night-dash-row">
            <div class="night-dash-label">ë‚´ ì¬ë£Œ</div>
            <div id="nightHand" class="night-dash-content"></div>
        </div>
        <div class="night-dash-row">
            <div class="night-dash-label">ë‚´ ìœ ë¬¼</div>
            <div id="nightArtifacts" class="night-dash-content"></div>
        </div>
    </div>
    <p style="color:#ccc; margin-bottom:10px;">ì›í•˜ëŠ” ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”. (ë™ì‹œ ê³µê°œ / ì¤‘ë³µ ì‹œ íšë“ ë¶ˆê°€)</p>
    <div class="loki-market" id="lokiMarket"></div>
    <div style="margin-top:20px;">
        <button id="btnRevealLoki" class="modal-btn btn-next" style="display:none;" onclick="game.revealLokiResults()">ê²°ê³¼ ê³µê°œ</button>
        <button id="btnEndNight" class="modal-btn btn-next" style="display:none;" onclick="game.finishNight()">ë‹¤ìŒ ë‚ ë¡œ</button>
    </div>
    <div id="nightLog" style="margin-top:20px; color:#fff; font-weight:bold; min-height:100px; width:80%; border:1px solid #555; background:rgba(0,0,0,0.5); padding:10px; overflow-y:auto;"></div>
</div>

<div class="dev-fab" onclick="game.toggleDevMenu()">ğŸ› ï¸</div>
<div id="devLokiModal" class="modal">
    <div class="modal-content" style="min-width: 800px; max-height:80vh;">
        <h2 style="color:#e040fb;">ğŸƒ ë¡œí‚¤ ì¹´ë“œ ê²€ìƒ‰ ë° íšë“</h2>
        <input type="text" id="devLokiSearchInput" class="dev-search-input" placeholder="ì¹´ë“œ ì´ë¦„ ê²€ìƒ‰..." onkeyup="game.filterDevLoki()">
        <div id="devLokiList" class="card-list" style="justify-content:center; overflow-y:auto; flex:1;"></div>
        <div class="modal-btn-group">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('devLokiModal').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>
</div>
<div id="devMenu" class="dev-menu">
    <button class="dev-btn" id="btnDevToggle" onclick="game.toggleDevMode()">ê°œë°œì ëª¨ë“œ: OFF</button>
    <button class="dev-btn" onclick="game.openDevArtifactSearch()">ğŸ” ëª¨ë“  ìœ ë¬¼ ê²€ìƒ‰/ì œì‘</button>
<button class="dev-btn" onclick="game.openDevLokiSearch()">ğŸƒ ë¡œí‚¤ ì¹´ë“œ ê²€ìƒ‰/íšë“</button>
    <button class="dev-btn" onclick="location.reload()">âš ï¸ ê²Œì„ ë¦¬ì…‹</button>
</div>
<div id="global-tooltip"></div>
<script>
class AudioManager {
    constructor() {
        this.bgm = document.getElementById('bgmAudio');
        this.sfxHover = document.getElementById('sfxHover');
        this.sfxSelect = document.getElementById('sfxSelect');
        this.sfxTurnStart = document.getElementById('sfxTurnStart');
        this.bgmVolume = 0.5; this.sfxVolume = 0.5;
        this.bgm.volume = this.bgmVolume;
        this.sfxHover.volume = this.sfxVolume;
        this.sfxSelect.volume = this.sfxVolume;
        this.sfxTurnStart.volume = this.sfxVolume;
    }
    playBgm() { this.bgm.play().catch(e => console.log("BGM Autoplay blocked")); }
    pauseBgm() { this.bgm.pause(); }
    playHover() {
        if (this.sfxHover.paused) { this.sfxHover.currentTime = 0; this.sfxHover.play().catch(() => {}); }
        else { this.sfxHover.currentTime = 0; this.sfxHover.play().catch(() => {}); }
    }
    playSelect() { this.sfxSelect.currentTime = 0; this.sfxSelect.play().catch(() => {}); }
    playTurnStart() { this.sfxTurnStart.currentTime = 0; this.sfxTurnStart.play().catch(() => {}); }
    setBgmVolume(val) { this.bgmVolume = val; this.bgm.volume = val; document.getElementById('bgmVal').innerText = Math.round(val * 100) + '%'; }
    setSfxVolume(val) { 
        this.sfxVolume = val; 
        this.sfxHover.volume = val; 
        this.sfxSelect.volume = val; 
        this.sfxTurnStart.volume = val; 
        document.getElementById('sfxVal').innerText = Math.round(val * 100) + '%'; 
    }
    openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
    closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
}
const audioManager = new AudioManager();

const CONFIG = { MAX_TIME: 12, MAX_DAYS: 5, HAND_LIMIT: 8, COST: { RES: 3, BLESS: 2, ART: 2, RESERVE: 1, SWAP: 1 } };
const RES_NAMES = { adamantite: "ì•„ë‹¤ë§Œíƒ€ì´íŠ¸", mithril: "ë¯¸ìŠ¤ë¦´", dragonBone: "ìš©ì˜ ë¼ˆ", starFragment: "ë³„ì˜ íŒŒí¸" };
const TYPE_NAMES = { nord: "ë…¸ë¥´ë“œ", egypt: "ì´ì§‘íŠ¸", olympus: "ì˜¬ë¦¼í¬ìŠ¤", celt: "ì¼ˆíŠ¸" };

const CONSTELLATION_DB = [
    {id:1, name:"ì–‘ìë¦¬", desc:"ì‹œì‘ ì‹œ ìì› 2ì¥ ë³´ìœ ", type:"start_res", val:2},
    {id:2, name:"í™©ì†Œìë¦¬", desc:"ì‹œì‘ ì‹œ ìì› 1ì¥ ê³µê°œ, í•´ë‹¹ ìì› ìˆ˜ì¹˜ +1", type:"passive_value_up"},
    {id:3, name:"ìŒë‘¥ì´ìë¦¬", desc:"ì‹œì‘ ì‹œ ë¡œí‚¤ ì¹´ë“œ 1ì¥ ë³´ìœ ", type:"start_loki", val:1},
    {id:4, name:"ê²Œìë¦¬", desc:"ì‹œì‘ ì‹œ ìœ ë¬¼ 1ì¥ ë³´ê´€í•¨ì— ë³´ìœ ", type:"start_reserve", val:1},
    {id:5, name:"ì‚¬ììë¦¬", desc:"ì‹œì‘ ì‹œ ìœ ë¬¼ 5ì¥ ì œê±°", type:"start_remove_art", val:5},
    {id:6, name:"ë¬¼ê³ ê¸°ìë¦¬", desc:"ì¶•ë³µ ì‹œì¥ 6ì¥ìœ¼ë¡œ í™•ì¥", type:"market_expand_bless", val:6},
    {id:7, name:"ë¬¼ë³‘ìë¦¬", desc:"ì‹œì‘ ì‹œ ì¶•ë³µ 2ì¥ ë³´ìœ ", type:"start_bless", val:2},
    {id:8, name:"ì „ê°ˆìë¦¬", desc:"ì€ì´ ì œì‘ ì‹œ ê°€ì¥ ë‚®ì€ ì¬ë£Œ ë°˜í™˜", type:"craft_refund"},
    {id:9, name:"ê¶ìˆ˜ìë¦¬", desc:"ìì› ì‹œì¥ 8ì¥ìœ¼ë¡œ í™•ì¥", type:"market_expand_res", val:8},
    {id:10, name:"ì²œì¹­ìë¦¬", desc:"ì‹œì¥ ìì› ì¤‘ë³µ 4ì¥ ì‹œ ì „ë©´ êµì²´", type:"market_auto_reset"},
    {id:11, name:"ë±€ì£¼ì¸ìë¦¬", desc:"2~4ì¼ì°¨ ì•„ì¹¨ë§ˆë‹¤ ë³´ìƒ(ì¶•ë³µ/ìì›/ë¡œí‚¤)", type:"daily_gift"},
  {id:12, name:"ì²˜ë…€ìë¦¬", desc:"ë‚® ì¢…ë£Œ ì‹œ ì˜¤ë²„íƒ€ì„(12H ì´ˆê³¼) ì—†ì´ ë§ˆì¹œ í”Œë ˆì´ì–´ +2ì ", type:"day_end_score"},
{id:13, name:"ì—¼ì†Œìë¦¬", desc:"ê²Œì„ ì‹œì‘ ì‹œ ë¬´ì‘ìœ„ ìœ ë¬¼ 1ê°œë¥¼ ëŒ€ì—¬í•©ë‹ˆë‹¤. ì´ ìœ ë¬¼ì€ 3ì¼ì°¨ ë°¤ ì¢…ë£Œ ì‹œ íšŒìˆ˜ë©ë‹ˆë‹¤.", type:"temporary_artifact"}
];

const LOKI_DB=[
    {id:1,name:"êµ¬ë¶€ëŸ¬ì§„ ì‹œê³—ë°”ëŠ˜",desc:"ì‚¬ìš© ì‹œ ì‹œê°„ -1H",type:"active_time"},
    {id:2,name:"ë§ê°ì˜ ì£¼íŒ",desc:"ë³´ê´€ ì¤‘ì¸ ìœ ë¬¼ 1ì¥ì„ ì¤‘ì•™ì˜ ìœ ë¬¼ 1ì¥ê³¼ êµí™˜í•©ë‹ˆë‹¤.",type:"active_swap"},
    {id:3,name:"ë¶ˆì™„ì „í•œ ì¶•ë³µ",desc:"ë…¸ë¥´ë“œ / ì¼ˆíŠ¸",type:"bless_split",tags:['nord','celt']},
    {id:4,name:"ë¶ˆì™„ì „í•œ ì¶•ë³µ",desc:"ë…¸ë¥´ë“œ / ì´ì§‘íŠ¸",type:"bless_split",tags:['nord','egypt']},
    {id:5,name:"ë¶ˆì™„ì „í•œ ì¶•ë³µ",desc:"ë…¸ë¥´ë“œ / ì˜¬ë¦¼í¬ìŠ¤",type:"bless_split",tags:['nord','olympus']},
    {id:6,name:"ë¶ˆì™„ì „í•œ ì¶•ë³µ",desc:"ì˜¬ë¦¼í¬ìŠ¤ / ì´ì§‘íŠ¸",type:"bless_split",tags:['olympus','egypt']},
    {id:7,name:"ë¶ˆì™„ì „í•œ ì¶•ë³µ",desc:"ì´ì§‘íŠ¸ / ì¼ˆíŠ¸",type:"bless_split",tags:['egypt','celt']},
    {id:8,name:"ë¶ˆì™„ì „í•œ ì¶•ë³µ",desc:"ì˜¬ë¦¼í¬ìŠ¤ / ì¼ˆíŠ¸",type:"bless_split",tags:['olympus','celt']},
    {id:9,name:"í˜¼ëˆì˜ ì±„ì„ë§ì¹˜",desc:"ìì› ì‹œì¥ ë¬´ë£Œ êµì²´",type:"active_reset"},
    {id:10,name:"ë¶€ì„œì§„ íšŒì¤‘ì‹œê³„",desc:"ìœ ë¬¼ ë¬´ë£Œ ì œì‘",type:"passive_free"},
    {id:11,name:"ê³„ìŠ¹ìì˜ ë¬¸ì¥",desc:"ì¦‰ì‹œ ì€ì´ ì ìˆ˜ +2",type:"instant_score"},
    {id:12,name:"ë¯¸ë˜ ì¼ê¸°",desc:"ìœ ë¬¼ ì¹´ë“œ ë”ë¯¸ ë§¨ ìœ„ 3ì¥ì„ í™•ì¸í•˜ê³ , ê·¸ì¤‘ 1ì¥ì„ ë³´ê´€í•©ë‹ˆë‹¤.",type:"active_peek"},
    {id:13,name:"ê²€ì€ ì£¼ì‚¬ìœ„",desc:"ìì› 2ì¥ ë²„ë¦¬ê³  2ì¥ ë½‘ê¸°",type:"active_draw"},
    {id:14,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ë³„ì˜ íŒŒí¸ 4 / ìš©ì˜ ë¼ˆ 4",type:"res_split",mode:"OR",options:[{type:'starFragment',val:4},{type:'dragonBone',val:4}]},
    {id:15,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ë³„ì˜ íŒŒí¸ 4 / ë¯¸ìŠ¤ë¦´ 4",type:"res_split",mode:"OR",options:[{type:'starFragment',val:4},{type:'mithril',val:4}]},
    {id:16,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ë³„ì˜ íŒŒí¸ 4 / ì•„ë‹¤ë§Œíƒ€ì´íŠ¸ 4",type:"res_split",mode:"OR",options:[{type:'starFragment',val:4},{type:'adamantite',val:4}]},
    {id:17,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ì•„ë‹¤ë§Œíƒ€ì´íŠ¸ 4 / ìš©ì˜ ë¼ˆ 4",type:"res_split",mode:"OR",options:[{type:'adamantite',val:4},{type:'dragonBone',val:4}]},
    {id:18,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ì•„ë‹¤ë§Œíƒ€ì´íŠ¸ 4 / ë¯¸ìŠ¤ë¦´ 4",type:"res_split",mode:"OR",options:[{type:'adamantite',val:4},{type:'mithril',val:4}]},
    {id:19,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ìš©ì˜ ë¼ˆ 4 / ë¯¸ìŠ¤ë¦´ 4",type:"res_split",mode:"OR",options:[{type:'dragonBone',val:4},{type:'mithril',val:4}]},
    {id:20,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ì•„ë‹¤ë§Œíƒ€ì´íŠ¸ 2 + ìš©ì˜ ë¼ˆ 2",type:"res_split",mode:"AND",options:[{type:'adamantite',val:2},{type:'dragonBone',val:2}]},
    {id:21,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ì•„ë‹¤ë§Œíƒ€ì´íŠ¸ 2 + ë¯¸ìŠ¤ë¦´ 2",type:"res_split",mode:"AND",options:[{type:'adamantite',val:2},{type:'mithril',val:2}]},
    {id:22,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ìš©ì˜ ë¼ˆ 2 + ë¯¸ìŠ¤ë¦´ 2",type:"res_split",mode:"AND",options:[{type:'dragonBone',val:2},{type:'mithril',val:2}]},
    {id:23,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ìš©ì˜ ë¼ˆ 2 + ë³„ì˜ íŒŒí¸ 2",type:"res_split",mode:"AND",options:[{type:'dragonBone',val:2},{type:'starFragment',val:2}]},
    {id:24,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ë³„ì˜ íŒŒí¸ 2 + ë¯¸ìŠ¤ë¦´ 2",type:"res_split",mode:"AND",options:[{type:'starFragment',val:2},{type:'mithril',val:2}]},
    {id:25,name:"ë¶ˆì•ˆì • ìœµí•©ì„",desc:"ì•„ë‹¤ë§Œíƒ€ì´íŠ¸ 2 + ë³„ì˜ íŒŒí¸ 2",type:"res_split",mode:"AND",options:[{type:'adamantite',val:2},{type:'starFragment',val:2}]},
    {id:26,name:"íŒŒê´´ëœ ì„±ë°°",desc:"ì¶•ë³µ ì‹œì¥ ë¬´ë£Œ êµì²´",type:"active_reset_bless"}
];

const ARTIFACT_DB = [
    {name:"ê·€ê²ŒìŠ¤ì˜ ë°˜ì§€", type:"olympus", score:4, grade:"Bronze", cost:{adamantite:3, starFragment:3}},
    {name:"í—¤ë¥´ë©”ìŠ¤ì˜ ì‹ ë°œ", type:"olympus", score:5, grade:"Bronze", cost:{dragonBone:3, mithril:4}},
    {name:"í¬ë¦¬ì…€ë¼ì¹´í† ìŠ¤", type:"olympus", score:6, grade:"Bronze", cost:{mithril:3, starFragment:5}},
    {name:"í€´ë„¤ì—", type:"olympus", score:10, grade:"Silver", cost:{dragonBone:2, mithril:4, starFragment:5}},
    {name:"ì¼€ìŠ¤í† ìŠ¤ íˆë§ˆìŠ¤", type:"olympus", score:12, grade:"Silver", cost:{adamantite:4, starFragment:9}},
    {name:"íŠ¸ë¼ì•„ì´ë‚˜", type:"olympus", score:12, grade:"Silver", cost:{adamantite:2, dragonBone:7, mithril:3}},
    {name:"ì•„í´ë¡ ì˜ ë¦¬ë¼", type:"olympus", score:14, grade:"Silver", cost:{adamantite:6, dragonBone:3, starFragment:6}},
    {name:"ì•„ì´ê¸°ìŠ¤", type:"olympus", score:14, grade:"Silver", cost:{adamantite:7, dragonBone:8}},
    {name:"íí”¼ë“œì˜ í™”ì‚´", type:"olympus", score:16, grade:"Silver", cost:{adamantite:5, dragonBone:3, mithril:7, starFragment:2}},
    {name:"ì•„ë‹¤ë§ŒíŠ¸", type:"olympus", score:16, grade:"Silver", cost:{adamantite:12, dragonBone:2, starFragment:3}},
    {name:"ì•„ìŠ¤íŠ¸ë¼í˜", type:"olympus", score:24, grade:"Gold", cost:{adamantite:3, dragonBone:5, mithril:5, starFragment:12}},
    {name:"ë§ˆì•„íŠ¸ì˜ ê¹ƒí„¸", type:"egypt", score:4, grade:"Bronze", cost:{dragonBone:3, mithril:3}},
    {name:"ì˜¤ì‹œë¦¬ìŠ¤ì˜ ì™•í™€", type:"egypt", score:5, grade:"Bronze", cost:{adamantite:2, mithril:6}},
    {name:"ì•„ëˆ„ë¹„ìŠ¤ì˜ ì €ìš¸", type:"egypt", score:6, grade:"Bronze", cost:{adamantite:2, dragonBone:6}},
    {name:"ì„¸íŠ¸ì˜ ì „ìŸ ë„ë¼", type:"egypt", score:10, grade:"Silver", cost:{adamantite:6, dragonBone:2, mithril:2}},
    {name:"ì„¸í¬ë©”íŠ¸ì˜ ì—­ë³‘", type:"egypt", score:12, grade:"Silver", cost:{adamantite:3, dragonBone:6, mithril:3}},
    {name:"í† íŠ¸ì˜ ì„œ", type:"egypt", score:12, grade:"Silver", cost:{dragonBone:2, mithril:6, starFragment:5}},
    {name:"ì•„í©ì˜ ì´ë¹¨", type:"egypt", score:14, grade:"Silver", cost:{dragonBone:7, mithril:6, starFragment:2}},
    {name:"í˜¸ë£¨ìŠ¤ì˜ ëˆˆ", type:"egypt", score:14, grade:"Silver", cost:{adamantite:4, mithril:6, starFragment:5}},
    {name:"í¬ëˆ”ì˜ ë¬¼ë ˆ", type:"egypt", score:16, grade:"Silver", cost:{adamantite:4, dragonBone:6, mithril:2, starFragment:5}},
    {name:"ë§Œì•¼ë¥´íŠ¸", type:"egypt", score:16, grade:"Silver", cost:{dragonBone:5, mithril:4, starFragment:8}},
    {name:"ëˆ„ì˜ í•­ì•„ë¦¬", type:"egypt", score:24, grade:"Gold", cost:{adamantite:3, dragonBone:14, mithril:2, starFragment:6}},
    {name:"ë“œë¼ìš°í”„ë‹ˆë¥´", type:"nord", score:4, grade:"Bronze", cost:{dragonBone:4, mithril:2}},
    {name:"ë¸Œë¦¬ì‹±ê°€ë©˜", type:"nord", score:5, grade:"Bronze", cost:{mithril:3, starFragment:4}},
    {name:"ë©”ê¸´ìš”ë¥´ë“œ", type:"nord", score:6, grade:"Bronze", cost:{adamantite:9}},
    {name:"ê·¸ëŒ", type:"nord", score:10, grade:"Silver", cost:{dragonBone:3, mithril:5, starFragment:3}},
    {name:"ìŠ¤ë°œë¦°", type:"nord", score:12, grade:"Silver", cost:{adamantite:5, mithril:8}},
    {name:"ê²”ë¼ë¥´ í˜¸ë¥¸", type:"nord", score:12, grade:"Silver", cost:{dragonBone:5, mithril:5, starFragment:3}},
    {name:"ë‹¤ì¸ìŠ¬ë ˆì´í”„", type:"nord", score:14, grade:"Silver", cost:{adamantite:5, mithril:3, starFragment:7}},
    {name:"ê¶ë‹ˆë¥´", type:"nord", score:14, grade:"Silver", cost:{adamantite:6, dragonBone:2, starFragment:6}},
    {name:"ê¸€ë ˆì´í”„ë‹ˆë¥´", type:"nord", score:16, grade:"Silver", cost:{adamantite:3, dragonBone:5, starFragment:8}},
    {name:"ë¬ ë‹ˆë¥´", type:"nord", score:16, grade:"Silver", cost:{adamantite:6, mithril:7, starFragment:4}},
    {name:"ë ˆë°”í…Œì¸", type:"nord", score:24, grade:"Gold", cost:{adamantite:11, dragonBone:4, mithril:5, starFragment:6}},
    {name:"ì˜¤í•œ", type:"celt", score:4, grade:"Bronze", cost:{adamantite:2, starFragment:4}},
    {name:"ëˆ„ì•„ë‹¤ì˜ ì€íŒ”", type:"celt", score:5, grade:"Bronze", cost:{dragonBone:4, starFragment:2}},
    {name:"ë‹¤ê·¸ë‹¤ì˜ ì†¥", type:"celt", score:6, grade:"Bronze", cost:{dragonBone:4, starFragment:4}},
    {name:"ë§ˆë‚˜ë‚œì˜ í™©ê¸ˆ ê°‘ì˜·", type:"celt", score:10, grade:"Silver", cost:{adamantite:7, starFragment:4}},
    {name:"ì¹¼ë¼ë“œë³¼ê·¸", type:"celt", score:12, grade:"Silver", cost:{adamantite:5, mithril:5, starFragment:2}},
    {name:"í˜ë¥´ë””ì•„ì˜ ë¿”ê°€ì£½", type:"celt", score:12, grade:"Silver", cost:{adamantite:5, dragonBone:6, mithril:2}},
    {name:"ê²Œ ë³¼ê·¸", type:"celt", score:14, grade:"Silver", cost:{adamantite:7, dragonBone:4, mithril:4}},
    {name:"ê²Œ ë‹¤ëŸ¬ê·¸", type:"celt", score:14, grade:"Silver", cost:{dragonBone:8, starFragment:7}},
    {name:"í”„ë¼ê°€ë¼í", type:"celt", score:16, grade:"Silver", cost:{adamantite:4, dragonBone:4, mithril:8}},
    {name:"ê²Œ ë¹„ì–´", type:"celt", score:16, grade:"Silver", cost:{adamantite:4, dragonBone:6, mithril:4, starFragment:2}},
    {name:"ë¸Œë¥˜ë‚˜í¬", type:"celt", score:24, grade:"Gold", cost:{dragonBone:5, mithril:17, starFragment:3}}
];class Card {
    constructor(cat, type, val = null, extra = null) {
        this.cat = cat; // resource, blessing, artifact, loki
        this.type = type; // specific type (e.g., 'nord', 'adamantite')
        this.val = val; // value for resources
        this.extra = extra; // loki card details or other metadata
        this.id = Math.random().toString(36).substr(2,9); // Unique ID for Drag & Drop
        this.used = false; // [NEW] Flag for preventing double counting in crafting
    }
    getImagePath() {
        if (this.cat === 'resource') return `images/res_${this.type}_${this.val}.png`;
        if (this.cat === 'blessing') return `images/bless_${this.type}.png`;
        if (this.cat === 'loki') return `images/loki_${this.extra.id}.png`; 
        return '';
    }
}

class Deck {
    constructor(cat) { this.cat = cat; this.cards = []; this.discardPile = []; this.init(); }
    init() {
        if (this.cat === 'resource') {
            const types = Object.keys(RES_NAMES); const vals = [2,3,4,5,6,7];
            types.forEach(t => vals.forEach(v => { for(let i=0; i<3; i++) this.cards.push(new Card('resource', t, v)); }));
        } else if (this.cat === 'blessing') {
            const types = Object.keys(TYPE_NAMES);
            types.forEach(t => { for(let i=0; i<8; i++) this.cards.push(new Card('blessing', t)); });
        } else if (this.cat === 'artifact') { 
            ARTIFACT_DB.forEach(art => this.cards.push({...art})); // Clone object
       } else if (this.cat === 'loki') {
            // [ìˆ˜ì •] CSV v1.9 ê¸°ì¤€ ì •í™•í•œ ìˆ˜ëŸ‰ ë°˜ì˜ (ì´ 32ì¥)
            // ID 1(ì‹œê³„), 11(ë¬¸ì¥)ì€ 4ì¥ì”©, ë‚˜ë¨¸ì§€ëŠ” 1ì¥ì”©
            const lokiCounts = [
                {id:1, count:4}, {id:2, count:1}, {id:3, count:1}, {id:4, count:1},
                {id:5, count:1}, {id:6, count:1}, {id:7, count:1}, {id:8, count:1},
                {id:9, count:1}, {id:10, count:1}, {id:11, count:4}, {id:12, count:1},
                {id:13, count:1}, {id:14, count:1}, {id:15, count:1}, {id:16, count:1},
                {id:17, count:1}, {id:18, count:1}, {id:19, count:1}, {id:20, count:1},
                {id:21, count:1}, {id:22, count:1}, {id:23, count:1}, {id:24, count:1},
                {id:25, count:1}, {id:26, count:1}
            ];

            lokiCounts.forEach(def => {
                const itemData = LOKI_DB.find(dbItem => dbItem.id === def.id);
                if (itemData) {
                    for(let i=0; i<def.count; i++) {
                        this.cards.push(new Card('loki', 'loki', null, itemData));
                    }
                }
            });
        }
        this.shuffle();
    }
    shuffle() { this.cards.sort(() => Math.random() - 0.5); }
    draw() {
        if (this.cards.length === 0) {
            if (this.cat === 'loki' || this.discardPile.length === 0) return null;
            // Recycle discard pile
            this.cards = [...this.discardPile]; this.discardPile = []; this.shuffle();
        }
        return this.cards.pop();
    }
    peek(count) { // [NEW] For Future Diary
        return this.cards.slice(-count).reverse(); 
    }
    discard(card) { 
        // Reset card state before discarding
        if(card.extra) card.used = false;
        this.discardPile.push(card); 
    }
    getCount() { return this.cards.length; }
    getDiscardCount() { return this.discardPile.length; }
}

class Player {
    constructor(id) {
        this.id = id; 
        this.hand = []; 
        this.reserved = []; 
        this.artifacts = []; 
        this.score = 0; 
        this.time = 0; 
        this.stackOrder = 0; 
        this.isAI = (id !== 1); 
        this.aiTargetIdx = null; 
        this.nordMode = false; 
        this.nordSelected = new Set();
        this.olympusDiscount = { type: null, amount: 0 };
        this.celtConvertCount = 0;
    }
    // [Updated] Hand count now includes Loki cards correctly for limit checks
 // [ìˆ˜ì •] ë¡œí‚¤ ì¹´ë“œëŠ” í•¸ë“œ ì œí•œ ê°œìˆ˜ì—ì„œ ì œì™¸ (Bug Fix)
    getHandCount() { 
        return this.hand.filter(c => c.cat !== 'loki').length; 
    }
}

class Game {
    constructor() { 
        this.isInitialized = false; 
        this.dragSourceIdx = -1;
    }
    
    startGame(enableConstellation) {
        document.getElementById('startModal').style.display = 'none';
        audioManager.playBgm(); 
        this.init(enableConstellation);
    }
startTestMode(constellationId) {
        document.getElementById('startModal').style.display = 'none';
        audioManager.playBgm();
        this.init(true, constellationId); // íŠ¹ì • ë³„ìë¦¬ IDë¥¼ ê°•ì œë¡œ ë„˜ê¹€
    }

  init(enableConstellation, fixedConstellationId = null) {
        this.day = 1; 
        this.isGameEnded = false; // [NEW] Game End Flag
this.lastActivePlayer = null;
        this.players = [ new Player(1), new Player(2), new Player(3), new Player(4) ];
        
        // Stack order initialization
        this.players[3].stackOrder = 0; this.players[2].stackOrder = 1;
        this.players[1].stackOrder = 2; this.players[0].stackOrder = 3;
        
        this.pIdx = 0; this.devMode = false;
        
        this.deckRes = new Deck('resource'); this.deckBless = new Deck('blessing');
        this.deckArt = new Deck('artifact'); this.deckLoki = new Deck('loki');
        
        this.fieldRes = []; this.fieldBless = []; this.fieldArt = []; this.lokiOffers = [];
        this.constellationMode = enableConstellation; this.activeConstellation = null; this.taurusBonusType = null;
        
 if (this.constellationMode) {
            let cIdx;
            if (fixedConstellationId) {
                // í…ŒìŠ¤íŠ¸ ëª¨ë“œì¼ ê²½ìš°: ì „ë‹¬ë°›ì€ IDë¡œ ê³ ì •
                cIdx = CONSTELLATION_DB.findIndex(c => c.id === fixedConstellationId);
            } else {
                // ì¼ë°˜ ëª¨ë“œì¼ ê²½ìš°: ëœë¤ ì„ íƒ
                cIdx = Math.floor(Math.random() * CONSTELLATION_DB.length);
            }
            this.activeConstellation = CONSTELLATION_DB[cIdx];
            this.applyConstellationStartEffect();
        }
        this.fill('resource', this.getMarketSize('resource')); 
        this.fill('blessing', this.getMarketSize('blessing')); 
        this.fill('artifact', 7);
        
        this.selectedArtIdx = -1; this.isWorkingFromReserve = false; 
        this.craftSelection = new Set(); this.nightSelections = {}; 
        this.swapState = { handIdx: -1, reserveIdx: -1, marketIdx: -1 };
        this.turnOverlayTimer = null;
        this.futureDiaryState = { active: false, handIdx: -1 }; // [NEW] Future Diary State
        
        this.initMap(); this.render(); this.renderConstellationUI(); this.checkTurnStart();
        this.initDragAndDrop();
        this.isInitialized = true;
    }

    get cp() { return this.players[this.pIdx]; }

    applyConstellationStartEffect() {
        if (!this.activeConstellation) return;
        const type = this.activeConstellation.type;
        this.players.forEach(p => {
            if (type === 'start_res') { for(let i=0; i<2; i++) { const c = this.deckRes.draw(); if(c) p.hand.push(c); } }
            else if (type === 'start_loki') { const c = this.deckLoki.draw(); if(c) p.hand.push(c); }
            else if (type === 'start_reserve') { const c = this.deckArt.draw(); if(c) p.reserved.push(c); }
            else if (type === 'start_bless') { for(let i=0; i<2; i++) { const c = this.deckBless.draw(); if(c) p.hand.push(c); } }
        });
        
        if (type === 'passive_value_up') { 
            const guideCard = this.deckRes.draw();
            if (guideCard) {
                this.taurusBonusType = guideCard.type;
                this.deckRes.discard(guideCard); this.deckRes.shuffle();
                setTimeout(()=>alert(`[í™©ì†Œìë¦¬ ë°œë™]\nê³µê°œëœ ì¹´ë“œ: ${RES_NAMES[this.taurusBonusType]}\nì´ë²ˆ ê²Œì„ ë™ì•ˆ í•´ë‹¹ ìì› ìˆ˜ì¹˜ +1`), 500);
            }
        } else if (type === 'start_remove_art') { 
            let removedNames = [];
            for(let i=0; i<5; i++) { 
                const c = this.deckArt.draw(); 
                if(c) removedNames.push(c.name); 
            }
            setTimeout(() => alert(`[ì‚¬ììë¦¬ ë°œë™]\nê²Œì„ì—ì„œ ì œì™¸ëœ ìœ ë¬¼ 5ì¥:\n- ${removedNames.join('\n- ')}`), 500);
        }
else if (type === 'temporary_artifact') {
            this.players.forEach(p => {
                const art = this.deckArt.draw();
                if (art) {
                    // ìœ ë¬¼ ì†ì„± ì¡°ì‘: ì„ì‹œ(Temp), ì ìˆ˜ 0, ì€ì´ ì—†ìŒ
                    art.isTemp = true; 
                    art.isGrace = false; 
                    art.finalScore = 0; 
                    art.bonus = 0;
                    
                    // ì¸ë²¤í† ë¦¬ì— ê°•ì œ ì£¼ì…
                    p.artifacts.push(art);
                }
            });
            setTimeout(() => alert(`[ì—¼ì†Œìë¦¬ ë°œë™]\nê° í”Œë ˆì´ì–´ì—ê²Œ ìœ ë¬¼ì´ 1ê°œì”© ëŒ€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ëŠ¥ë ¥ì€ ë°œë™í•˜ì§€ë§Œ ì ìˆ˜ëŠ” ì—†ìœ¼ë©°, 3ì¼ì°¨ ë°¤ì— íšŒìˆ˜ë©ë‹ˆë‹¤.)`), 500);
        }
    }

    // --- Drag and Drop Logic ---
    initDragAndDrop() {
        const handContainer = document.getElementById('myHand');
        
        handContainer.addEventListener('dragover', (e) => {
            e.preventDefault(); 
            handContainer.classList.add('drag-over');
            const afterElement = this.getDragAfterElement(handContainer, e.clientX);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) {
                handContainer.appendChild(draggable);
            } else {
                handContainer.insertBefore(draggable, afterElement);
            }
        });

        handContainer.addEventListener('dragleave', () => {
            handContainer.classList.remove('drag-over');
        });

        handContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            handContainer.classList.remove('drag-over');
            this.updateHandOrder();
        });
    }

    getDragAfterElement(container, x) {
        const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    updateHandOrder() {
        const handContainer = document.getElementById('myHand');
        const newHand = [];
        [...handContainer.children].forEach(child => {
            const id = child.getAttribute('data-id');
            const card = this.cp.hand.find(c => c.id === id);
            if (card) newHand.push(card);
        });
        this.cp.hand = newHand;
    }
    // ---------------------------------

    renderConstellationUI() {
        const banner = document.getElementById('constellationBanner');
        if (!this.constellationMode || !this.activeConstellation) { banner.style.display = 'none'; return; }
        banner.style.display = 'block';
        document.getElementById('constellationName').innerText = this.activeConstellation.name;
        document.getElementById('constellationDesc').innerText = this.activeConstellation.desc;
        if (this.activeConstellation.type === 'passive_value_up' && this.taurusBonusType) {
            document.getElementById('taurusInfo').style.display = 'block';
            document.getElementById('taurusTargetName').innerText = RES_NAMES[this.taurusBonusType];
        } else { document.getElementById('taurusInfo').style.display = 'none'; }
    }

    getMarketSize(cat) {
        let size = (cat === 'resource') ? 6 : (cat === 'blessing' ? 4 : 7);
        if (this.constellationMode && this.activeConstellation) {
            if (cat === 'resource' && this.activeConstellation.type === 'market_expand_res') size = 8;
            if (cat === 'blessing' && this.activeConstellation.type === 'market_expand_bless') size = 6;
        }
        return size;
    }

    toggleDevMenu() { const menu = document.getElementById('devMenu'); menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; }
    
    toggleDevMode() {
        this.devMode = !this.devMode;
        const btn = document.getElementById('btnDevToggle');
        btn.innerText = this.devMode ? 'ê°œë°œì ëª¨ë“œ: ON' : 'ê°œë°œì ëª¨ë“œ: OFF';
        if(this.devMode) btn.classList.add('dev-active'); else btn.classList.remove('dev-active');
        document.getElementById('titleDevMode').style.display = this.devMode ? 'inline' : 'none';
        this.render();
    }
    
    openDevArtifactSearch() { document.getElementById('devArtifactModal').style.display = 'flex'; this.filterDevArtifacts(); }
    
    filterDevArtifacts() {
        const query = document.getElementById('devSearchInput').value.toLowerCase();
        const listEl = document.getElementById('devArtifactList'); listEl.innerHTML = '';
        ARTIFACT_DB.forEach((art, i) => {
            if(art.name.toLowerCase().includes(query)) {
                const div = document.createElement('div');
                div.className = `card artifact type-${art.type} card-scale-down`;
                div.style.width = '100px'; div.style.height = '145px';
                let reqHtml = ''; for(const [k,v] of Object.entries(art.cost)) reqHtml += `<div>${RES_NAMES[k]}: ${v}</div>`;
                div.innerHTML = `<div class="artifact-info"><div class="art-name">${art.name}</div><div class="art-score" style="margin:5px 0;">â˜… ${art.score}</div><div style="font-size:10px; color:#aaa;">${reqHtml}</div></div>`;
                div.onclick = () => { if(confirm(`${art.name} íšë“?`)) this.devForceCraft(art); };
                listEl.appendChild(div);
            }
        });
    }
    
    devForceCraft(art) {
        const craftedArt = { ...art, isGrace: false, finalScore: art.score, bonus: 0 };
        this.players[0].artifacts.push(craftedArt); this.players[0].score += art.score;
        alert(`[DEV] ${art.name} íšë“ ì™„ë£Œ!`);
        document.getElementById('devArtifactModal').style.display = 'none'; this.render();
    }
// [ì¶”ê°€] ê°œë°œì ëª¨ë“œ: ë¡œí‚¤ ì¹´ë“œ ê²€ìƒ‰ì°½ ì—´ê¸°
    openDevLokiSearch() { document.getElementById('devLokiModal').style.display = 'flex'; this.filterDevLoki(); }

    // [ì¶”ê°€] ê°œë°œì ëª¨ë“œ: ë¡œí‚¤ ì¹´ë“œ í•„í„°ë§
    filterDevLoki() {
        const query = document.getElementById('devLokiSearchInput').value.toLowerCase();
        const listEl = document.getElementById('devLokiList'); listEl.innerHTML = '';
        
        // ì¤‘ë³µ ì—†ì´ ì¢…ë¥˜ë³„ë¡œ í•˜ë‚˜ì”©ë§Œ í‘œì‹œ
        const seenIds = new Set();
        
        LOKI_DB.forEach((item) => {
            if (seenIds.has(item.id)) return;
            if (item.name.toLowerCase().includes(query) || item.desc.toLowerCase().includes(query)) {
                seenIds.add(item.id);
                
                const c = new Card('loki', 'loki', null, item);
                const div = document.createElement('div');
                div.className = 'card type-loki';
                div.style.backgroundImage = `url('${c.getImagePath()}')`;
                div.style.width = '100px'; div.style.height = '145px';
                div.setAttribute('data-tooltip', `${item.name}\n${item.desc}`);
                
                // í´ë¦­ ì‹œ íšë“
                div.onclick = () => { 
                    if(confirm(`[DEV] ${item.name} ì¹´ë“œë¥¼ í•¸ë“œì— ì¶”ê°€í•©ë‹ˆê¹Œ?`)) {
                        this.players[0].hand.push(new Card('loki', 'loki', null, item));
                        alert(`${item.name} íšë“!`);
                        this.render();
                    }
                };
                listEl.appendChild(div);
            }
        });
    }
// [FIXED] ì‹œê°„ ì†Œëª¨(í–‰ë™) ì¦‰ì‹œ ì˜¤ë²„ë ˆì´ë¥¼ ì œê±°í•˜ì—¬ í´ë¦­ ë°©í•´ í•´ê²°
    consumeTime(amount) {
        if (this.devMode) amount = 0; 
        
        // [í•µì‹¬] í–‰ë™ì„ í–ˆìœ¼ë¯€ë¡œ ì˜¤ë²„ë ˆì´ë¥¼ ê°•ì œë¡œ ë•ë‹ˆë‹¤. 
        // ì´ê²ƒì´ ì—†ìœ¼ë©´ íƒ€ì´ë¨¸ê°€ ê¼¬ì˜€ì„ ë•Œ ì˜ì›íˆ í™”ë©´ì„ ê°€ë¦½ë‹ˆë‹¤.
        const ol = document.getElementById('turnOverlay');
        if(ol) ol.style.display = 'none';

        const oldTime = this.cp.time; 
        let targetTime = oldTime + amount;
        
        let maxStack = -1;
        this.players.forEach(p => { if (p.id !== this.cp.id && p.time === targetTime) { if (p.stackOrder > maxStack) maxStack = p.stackOrder; } });
        
        this.cp.time = targetTime; 
        this.cp.stackOrder = maxStack + 1;
        
        this.updateTimeUI(); 
        this.determineNextTurn();
    }
    
    passTurn() {
        if (!this.canAct(0)) return; 
        if(this.cp.time < CONFIG.MAX_TIME) { const cost = CONFIG.MAX_TIME - this.cp.time; this.consumeTime(cost); } 
        else { alert("ì´ë¯¸ í•˜ë£¨ë¥¼ ë§ˆì³¤ìŠµë‹ˆë‹¤."); }
    }
    
    determineNextTurn() {
        if (this.players.every(p => p.time >= CONFIG.MAX_TIME)) { this.showDayEndEffect(); return; }
        let candidates = this.players.filter(p => p.time < CONFIG.MAX_TIME);
        if (candidates.length === 0) { this.showDayEndEffect(); return; }
        
        // Sort by Time ASC, then Stack Order DESC
        candidates.sort((a, b) => { if (a.time !== b.time) return a.time - b.time; return b.stackOrder - a.stackOrder; });
        
        const nextPlayer = candidates[0];
        // AI Hand Limit Check
        if (nextPlayer.isAI && nextPlayer.getHandCount() > CONFIG.HAND_LIMIT) { 
            while (nextPlayer.getHandCount() > CONFIG.HAND_LIMIT) { this.aiSmartDiscard(nextPlayer); } 
        }
        
        if (nextPlayer.id !== this.cp.id) {
            // Player Hand Limit Check
            if (this.cp.id === 1 && this.cp.getHandCount() > CONFIG.HAND_LIMIT) { 
                alert(`ì¹´ë“œ 1ì¥ì„ ë²„ë ¤ì•¼ í„´ì„ ë„˜ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`); return; 
            }
            this.pIdx = this.players.indexOf(nextPlayer); 
            this.checkTurnStart();
        } else { 
            this.render(); 
            if (this.cp.isAI) { setTimeout(() => this.aiTurn(), 1000); } 
        }
    }
    
    aiSmartDiscard(aiPlayer) {
        let worstIdx = -1; let minScore = 999;
        aiPlayer.hand.forEach((c, i) => {
            let score = 10; 
            if (c.cat === 'resource') score = c.val; 
            else if (c.cat === 'blessing') score = 5; 
            else if (c.cat === 'loki') score = 20; 
            if (score < minScore) { minScore = score; worstIdx = i; }
        });
        if (worstIdx !== -1) {
            const c = aiPlayer.hand[worstIdx]; aiPlayer.hand.splice(worstIdx, 1);
            if (c.cat === 'resource') this.deckRes.discard(c); else if (c.cat === 'blessing') this.deckBless.discard(c);
            this.addLog(`[AI P${aiPlayer.id}] í•¸ë“œ ì´ˆê³¼ë¡œ ì •ë¦¬ (${c.cat === 'resource' ? c.val : 'ì¹´ë“œ'})`); 
            this.render();
        }
    }
    
showDayEndEffect() {
        const overlay = document.getElementById('dayEndOverlay'); 
        overlay.style.display = 'flex';
        
        setTimeout(() => { 
            overlay.style.display = 'none'; 
            
            // 1. ì—¼ì†Œìë¦¬ íš¨ê³¼: 4ì¼ì°¨ ë‚® ì¢…ë£Œ ì‹œ ì¦‰ì‹œ ê²Œì„ ì¢…ë£Œ
            if (this.constellationMode && this.activeConstellation.type === 'short_game' && this.day === 4) {
                this.endGame();
            } 
            // 2. [ì¶”ê°€ëœ ë¡œì§] ì •ê·œ ë§ˆì§€ë§‰ ë‚ (5ì¼ì°¨) ì¢…ë£Œ ì‹œ ì¦‰ì‹œ ê²Œì„ ì¢…ë£Œ
            else if (this.day >= CONFIG.MAX_DAYS) {
                this.endGame();
            }
            // 3. ê·¸ ì™¸ì˜ ë‚ (1~4ì¼ì°¨)ì€ ë°¤ ë‹¨ê³„ë¡œ ì§„í–‰
            else {
                this.startNightPhase(); 
            }
        }, 1200);
    }
    
    checkTurnStart() {
        if (!this.isInitialized) return;
if (this.lastActivePlayer !== this.cp.id) {
            this.cp.celtConvertCount = 0;
        }
        const ol = document.getElementById('turnOverlay'); const title = document.getElementById('turnTitle');
        if (this.turnOverlayTimer) { clearTimeout(this.turnOverlayTimer); this.turnOverlayTimer = null; }
        title.innerText = `Player ${this.cp.id} Turn`; title.className = `turn-title p${this.cp.id}-color`;
        
        if (this.cp.isAI) { 
            ol.style.display = 'none'; document.body.className = `p${this.cp.id}-turn`; 
            this.render(); setTimeout(() => this.aiTurn(), 1000); 
        } 
        else { 
            audioManager.playTurnStart();
            ol.style.display = 'flex'; document.body.className = `p${this.cp.id}-turn`; 
            this.render(); this.turnOverlayTimer = setTimeout(() => { ol.style.display = 'none'; }, 1500); 
        }
    }

animateAIAction(startEl, callback) {
        // 1. ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì½œë°± ì‹¤í–‰ (ë©ˆì¶¤ ë°©ì§€)
        if (!startEl) { 
            console.warn("[Ani] íƒ€ê²Ÿ ìš”ì†Œ ì—†ìŒ, ì¦‰ì‹œ ì¢…ë£Œ");
            if(callback) callback(); 
            return; 
        }

        try {
            const rect = startEl.getBoundingClientRect();
            const clone = startEl.cloneNode(true);
            clone.classList.add('flying-card');
            
            // ìœ„ì¹˜ ë³´ì •
            clone.style.width = rect.width + 'px'; 
            clone.style.height = rect.height + 'px';
            clone.style.left = rect.left + 'px'; 
            clone.style.top = rect.top + 'px';
            
            document.body.appendChild(clone);
            
            const targetEl = document.getElementById(`pieceP${this.cp.id}`);
            // íƒ€ê²Ÿì´ ì—†ìœ¼ë©´ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ
            const targetRect = targetEl ? targetEl.getBoundingClientRect() : { left: window.innerWidth/2, top: window.innerHeight/2 };
            
            // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
            setTimeout(() => { 
                if(clone) {
                    clone.style.left = targetRect.left + 'px'; 
                    clone.style.top = targetRect.top + 'px'; 
                    clone.style.opacity = '0'; 
                    clone.style.transform = 'scale(0.2)'; 
                }
            }, 50);

            // ì¢…ë£Œ ì²˜ë¦¬
            setTimeout(() => { 
                if(clone && clone.parentNode) clone.remove(); 
                if(callback) callback(); 
            }, 650);

        } catch (e) {
            console.error("[Ani Error] ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ì˜¤ë¥˜:", e);
            // ì—ëŸ¬ê°€ ë‚˜ë„ ì½œë°±ì€ ë°˜ë“œì‹œ ì‹¤í–‰í•´ì„œ ê²Œì„ì´ ë©ˆì¶”ì§€ ì•Šê²Œ í•¨
            if(callback) callback();
        }
    }
    render() {
        document.getElementById('dayInfo').innerText = `Day ${this.day}`;
        document.getElementById('playerInfo').innerText = `Player ${this.cp.id} Turn`;
        document.getElementById('playerInfo').className = `p${this.cp.id}-color`;
        document.getElementById('scoreInfo').innerText = `ì ìˆ˜: ${this.cp.score}`;
        document.getElementById('handInfo').innerText = `Hand: ${this.cp.getHandCount()}`;
        document.getElementById('costRes').innerText = this.getCost('RES');
        document.getElementById('costBless').innerText = this.getCost('BLESS');
        document.getElementById('costArt').innerText = this.getCost('ART');
        document.getElementById('costReserve').innerText = this.getCost('RESERVE');
        
        // Crafted Artifacts UI
        const craftedDiv = document.getElementById('craftedList'); craftedDiv.innerHTML = '';
        this.players.forEach(p => {
            const row = document.createElement('div'); row.className = `player-artifact-row p${p.id}-row`;
            const label = document.createElement('div'); label.className = 'player-label';
            label.innerHTML = `<div>Player ${p.id}</div><div style="font-size:10px; font-weight:normal;">(${p.score}ì )</div>`;
            row.appendChild(label);
            
            const listContainer = document.createElement('div'); listContainer.className = 'artifact-list-container';
            if (p.artifacts.length === 0) { listContainer.innerHTML = '<span style="font-size:11px; color:#555;">ìœ ë¬¼ ì—†ìŒ</span>'; } 
            else {
                p.artifacts.forEach(art => {
                    const div = document.createElement('div'); 
                    let classes = `card artifact type-${art.type} card-scale-down`;
                    let medalHtml = ''; 
                    
                    if(art.isGrace) { 
                        let mType = this.getMedalType(art.score - art.bonus); 
                        medalHtml = `<div class="medal-icon medal-${mType} shining" title="ì€ì´ (+${art.bonus})"></div>`; 
                    } else {
                         let mType = this.getMedalType(art.score);
                         medalHtml = `<div class="medal-icon medal-${mType}" style="box-shadow:none;"></div>`;
                    }
                    
                    div.className = classes; 
                    div.setAttribute('data-tooltip', `${art.name}\nâ˜…${art.finalScore}ì `);
                    div.innerHTML = `${medalHtml}<div class="artifact-info"><div class="art-type badge-${art.type}" style="font-size:8px; padding:1px;">${TYPE_NAMES[art.type]}</div><div class="art-name" style="font-size:9px; height:20px;">${art.name}</div></div>`;
                    listContainer.appendChild(div);
                });
            }
            row.appendChild(listContainer); craftedDiv.appendChild(row);
        });

        document.getElementById('deckRes').style.backgroundImage = "url('images/back_resource.png')";
        document.getElementById('deckBless').style.backgroundImage = "url('images/back_blessing.png')";
        document.getElementById('cntDeckRes').innerText = this.deckRes.getCount();
        document.getElementById('cntDiscRes').innerText = this.deckRes.getDiscardCount();
        document.getElementById('cntDeckBless').innerText = this.deckBless.getCount();
        document.getElementById('cntDiscBless').innerText = this.deckBless.getDiscardCount();
        
        const renderList = (elId, list, type) => {
            const el = document.getElementById(elId); el.innerHTML = '';
            list.forEach((c, i) => {
                const div = document.createElement('div');
                div.onmouseenter = () => audioManager.playHover();
                const disabled = (!this.devMode && this.cp.time >= CONFIG.MAX_TIME);
                
                if(type === 'artifact') {
                    div.className = `card artifact type-${c.type}`; 
                    let reqHtml = ''; for(const [k,v] of Object.entries(c.cost)) reqHtml += `<div class="req-row"><span>${RES_NAMES[k]}</span><span class="req-val">${v}</span></div>`;
                    let mType = this.getMedalType(c.score); let medalHtml = `<div class="medal-icon medal-${mType}" style="top:-5px; right:-5px; width:25px; height:25px;"></div>`;
                    div.innerHTML = `${medalHtml}<div class="artifact-info"><div class="art-type badge-${c.type}">${TYPE_NAMES[c.type]}</div><div class="art-name">${c.name}</div><div class="art-score">â˜… ${c.score}</div><div class="art-cost">${reqHtml}</div></div>`;
                    
                    if(disabled) div.classList.add('disabled'); 
                    else div.onclick = () => { 
                        audioManager.playSelect(); 
                        this.openCraftModal(i, false); 
                    };
                } else {
                    // [ì¶”ê°€] ìì› ì¹´ë“œ íˆ´íŒ ì„¤ì •
                    if (type === 'res') {
                        div.setAttribute('data-tooltip', `${RES_NAMES[c.type]} ${c.val}`);
                    }div.className = `card type-${c.type}`; div.style.backgroundImage = `url('${c.getImagePath()}')`;
                    if (this.cp.nordSelected && this.cp.nordSelected.has(i) && type === 'res') div.classList.add('market-selected'); 
                    
                    if(disabled) div.classList.add('disabled'); 
                    else div.onclick = () => { 
                        audioManager.playSelect(); 
                        if(type==='res') this.clickResourceCard(i); else this.getCard('blessing', i); 
                    };
                }
                el.appendChild(div);
            });
        };
        
        renderList('marketRes', this.fieldRes, 'res'); renderList('marketBless', this.fieldBless, 'bless'); renderList('marketArt', this.fieldArt, 'artifact');
        
         // [êµì²´ëœ ì½”ë“œ] ì¼ˆíŠ¸ ë³€í™˜ ë²„íŠ¼ + í•¸ë“œ ì¹´ë“œ ë Œë”ë§
        const hDiv = document.getElementById('myHand'); hDiv.innerHTML = '';
        
        // 1. ì¼ˆíŠ¸ ë³€í™˜ ë²„íŠ¼ ë¡œì§
        const celtLv = this.getArtLevel('celt');
        const swapLimit = celtLv >= 3 ? 3 : (celtLv >= 2 ? 2 : (celtLv >= 1 ? 1 : 0));
        
        let btnToggle = document.getElementById('btnToggleSwap');
        
        if (celtLv > 0 && !this.cp.isAI && this.cp.id === 1) {
            btnToggle.style.display = 'inline-block';
            if (this.isCeltConvertMode) {
                btnToggle.innerText = `â˜˜ï¸ ë³€í™˜ ì·¨ì†Œ (ë‚¨ì€ íšŸìˆ˜: ${swapLimit - this.cp.celtConvertCount})`;
                btnToggle.style.background = '#e67e22';
            } else {
                btnToggle.innerText = `â˜˜ï¸ ì¼ˆíŠ¸ ë³€í™˜ (${swapLimit - this.cp.celtConvertCount}íšŒ ë‚¨ìŒ)`;
                btnToggle.style.background = '#27ae60';
            }
            btnToggle.onclick = () => this.toggleCeltMode();
        } else {
            btnToggle.style.display = 'none';
        }

        // 2. ì¹´ë“œ ëª©ë¡ ìƒì„± ë¡œì§
      this.players[0].hand.forEach((c, i) => { 
            const div = document.createElement('div');
            div.setAttribute('draggable', 'true');
            div.setAttribute('data-id', c.id);
            div.classList.add('card-draggable');
            
            div.addEventListener('dragstart', () => { div.classList.add('dragging'); });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); });
            
            div.onmouseenter = () => audioManager.playHover();

            if(c.cat==='loki') { 
                div.className = 'card type-loki'; 
                div.style.backgroundImage = `url('${c.getImagePath()}')`; 
                div.setAttribute('data-tooltip', `${c.extra.name}\n${c.extra.desc}`);
            }
            else { 
                div.className = `card type-${c.type}`; 
                div.style.backgroundImage = `url('${c.getImagePath()}')`; 
            }
            
            div.style.width = '60px'; div.style.height = '87px';
            
            // [í´ë¦­ ì´ë²¤íŠ¸ ë¶„ê¸°] ë³€í™˜ ëª¨ë“œë©´ ëª¨ë‹¬ ì—´ê¸°, ì•„ë‹ˆë©´ ê¸°ì¡´ ë™ì‘
            div.onclick = () => { 
                audioManager.playSelect(); 
                if (this.isCeltConvertMode) {
                    this.openCeltConvertModal(i); 
                } else {
                    this.onHandCardClick(i); 
                }
            }; 
            hDiv.appendChild(div);
        });      const rDiv = document.getElementById('myReserved'); rDiv.innerHTML = '';
        if(this.players[0].reserved.length === 0) rDiv.innerHTML = '<div class="empty-slot">ë¹ˆ ìŠ¬ë¡¯</div>';
        else {
            this.players[0].reserved.forEach((c, i) => {
                const div = document.createElement('div');
                div.onmouseenter = () => audioManager.playHover();
                div.className = `card artifact type-${c.type}`; 
                let reqHtml = ''; for(const [k,v] of Object.entries(c.cost)) reqHtml += `<div class="req-row"><span>${RES_NAMES[k]}</span><span class="req-val">${v}</span></div>`;
                let mType = this.getMedalType(c.score); let medalHtml = `<div class="medal-icon medal-${mType}" style="top:-5px; right:-5px; width:25px; height:25px;"></div>`;
                div.innerHTML = `${medalHtml}<div class="reserved-badge">ë³´ê´€ë¨</div><div class="artifact-info"><div class="art-type badge-${c.type}">${TYPE_NAMES[c.type]}</div><div class="art-name">${c.name}</div><div class="art-score">â˜… ${c.score}</div><div class="art-cost">${reqHtml}</div></div>`;
                div.onclick = () => { 
                    audioManager.playSelect(); 
                    this.openCraftModal(i, true); 
                }; 
                rDiv.appendChild(div);
            });
        }
        
        // Nord Panel
        const nordLv = this.getArtLevel('nord'); const nordPanel = document.getElementById('nordPanel');
        if (nordLv > 0 && this.cp.nordMode && this.cp.id === 1) {
            nordPanel.style.display = 'block'; const indices = Array.from(this.cp.nordSelected);
            const sum = indices.reduce((a,b) => a + this.fieldRes[b].val, 0);
            document.getElementById('nordInfo').innerText = `ì„ íƒ: ${indices.length}ì¥ (í•©: ${sum})`;
        } else { nordPanel.style.display = 'none'; }
        
        // Celt Panel
        const celtLvReal = this.cp.artifacts.filter(a=>a.type==='celt').length; const celtPanel = document.getElementById('celtPanel'); 
        if (celtPanel) {
            if (celtLvReal >= 3 && this.cp.id === 1) { 
                celtPanel.style.display = 'block'; let modeText = "â‘  ìì›3ì¥ ë³€í™˜ + ì¶•ë³µë©´ì œ";
                if (this.cp.celtMimicMode) modeText = `â‘¡ ëŠ¥ë ¥ ëª¨ë°© ì¤‘: ${TYPE_NAMES[this.cp.celtMimicMode]}`;
                celtPanel.innerHTML = `<div style="font-size:12px; color:#2ecc71; font-weight:bold; margin-bottom:5px;">â˜˜ï¸ ì¼ˆíŠ¸ 3ë‹¨ê³„ ì„ íƒ</div><div style="font-size:11px; color:#ccc; margin-bottom:5px;">í˜„ì¬: ${modeText}</div><div style="display:flex; gap:5px;"><button class="btn" style="font-size:10px; padding:3px;" onclick="game.setCeltMode(null)">â‘  ë³€í™˜ëª¨ë“œ</button><button class="btn" style="font-size:10px; padding:3px; background:#9b59b6;" onclick="game.setCeltMode('nord')">â‘¡ ë…¸ë¥´ë“œ</button><button class="btn" style="font-size:10px; padding:3px; background:#ffd700; color:#333;" onclick="game.setCeltMode('egypt')">â‘¡ ì´ì§‘íŠ¸</button><button class="btn" style="font-size:10px; padding:3px; background:#00bfff;" onclick="game.setCeltMode('olympus')">â‘¡ ì˜¬ë¦¼í¬ìŠ¤</button></div>`;
            } else { celtPanel.style.display = 'none'; }
        }
        
        document.getElementById('btnSwapRes').disabled = (this.cp.time >= CONFIG.MAX_TIME);
        document.getElementById('btnSwapBless').disabled = (this.cp.time >= CONFIG.MAX_TIME);
        this.updateTimeUI();
    }
    toggleCeltMode() {
        this.isCeltConvertMode = !this.isCeltConvertMode;
        this.render();
    }

    openCeltConvertModal(handIdx) {
        const card = this.cp.hand[handIdx];
        if (card.cat !== 'resource') {
            alert("ìì› ì¹´ë“œë§Œ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        const celtLv = this.getArtLevel('celt');
        const limit = celtLv >= 3 ? 3 : (celtLv >= 2 ? 2 : 1);
        if (this.cp.celtConvertCount >= limit) {
            alert("ì´ë²ˆ í„´ì˜ ë³€í™˜ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        this.celtTargetIdx = handIdx;
        const listEl = document.getElementById('celtTargetList');
        listEl.innerHTML = '';

        const allTypes = ['adamantite', 'mithril', 'dragonBone', 'starFragment'];
        const targetTypes = allTypes.filter(t => t !== card.type);

        targetTypes.forEach(type => {
            const div = document.createElement('div');
            const dummyCard = new Card('resource', type, card.val); 
            div.className = `card type-${type}`;
            div.style.backgroundImage = `url('${dummyCard.getImagePath()}')`;
            div.style.width = '80px'; div.style.height = '116px';
            div.style.cursor = 'pointer';
            div.innerHTML = `<div style="background:rgba(0,0,0,0.7); color:#fff; position:absolute; bottom:0; width:100%; text-align:center; font-size:12px;">${RES_NAMES[type]} ${card.val}</div>`;
            div.onclick = () => this.executeCeltConvert(type);
            listEl.appendChild(div);
        });

        document.getElementById('celtConvertModal').style.display = 'flex';
    }

    executeCeltConvert(newType) {
        const idx = this.celtTargetIdx;
        const oldCard = this.cp.hand[idx];
        this.cp.hand[idx] = new Card('resource', newType, oldCard.val);
        this.cp.celtConvertCount++;
        this.addLog(`[ì¼ˆíŠ¸] ${RES_NAMES[oldCard.type]}(${oldCard.val}) â†’ ${RES_NAMES[newType]}(${oldCard.val}) ë³€í™˜ ì™„ë£Œ`);
        this.closeCeltModal();
        this.isCeltConvertMode = false; 
        this.render();
    }

    closeCeltModal() {
        document.getElementById('celtConvertModal').style.display = 'none';
        this.celtTargetIdx = -1;
    }
// [ì¶”ê°€] AI ì „ìš© ì¼ˆíŠ¸ ë³€í™˜ íŒë‹¨ ë¡œì§
    aiTryCeltConvert(targetArt) {
        const ai = this.cp;
        const celtLv = this.getArtLevel('celt');
        if (celtLv === 0) return false; 

        const limit = celtLv >= 3 ? 3 : (celtLv >= 2 ? 2 : 1);
        if (ai.celtConvertCount >= limit) return false; 

        // 1. ë¶€ì¡±í•œ ìì› íŒŒì•…
        let needed = {};
        let surplus = []; 
        
        let myRes = { adamantite:0, mithril:0, dragonBone:0, starFragment:0 };
        ai.hand.forEach((c, i) => {
            if(c.cat === 'resource') {
                myRes[c.type]++;
                surplus.push({ idx: i, type: c.type, val: c.val });
            }
        });

        for(const [type, req] of Object.entries(targetArt.cost)) {
            let actualReq = req;
            if (ai.olympusDiscount && ai.olympusDiscount.type === type) {
                actualReq = Math.max(0, req - ai.olympusDiscount.amount);
            }
            
            let currentVal = 0;
            ai.hand.forEach(c => { if(c.cat==='resource' && c.type === type) currentVal += c.val; });
            
            if (currentVal < actualReq) {
                needed[type] = actualReq - currentVal;
            }
        }

        // 2. ë³€í™˜ ì‹¤í–‰
        const neededTypes = Object.keys(needed);
        if (neededTypes.length === 0) return false;

        let didConvert = false;

        for (const targetType of neededTypes) {
            if (ai.celtConvertCount >= limit) break;

            const sacrificeIdx = surplus.findIndex(item => !neededTypes.includes(item.type));
            
            if (sacrificeIdx !== -1) {
                const item = surplus[sacrificeIdx];
                const handRealIdx = item.idx;
                
                const oldType = ai.hand[handRealIdx].type;
                ai.hand[handRealIdx] = new Card('resource', targetType, item.val);
                ai.celtConvertCount++;
                
                this.addLog(`[AI P${ai.id}] ì¼ˆíŠ¸ ë³€í™˜: ${RES_NAMES[oldType]} -> ${RES_NAMES[targetType]}`);
                
                surplus.splice(sacrificeIdx, 1); 
                didConvert = true;
            }
        }
        
        if (didConvert) this.render();
        return didConvert;
    }
    // --- Action Methods ---
    setCeltMode(mode) { this.cp.celtMimicMode = mode; this.render(); this.updateTimeUI(); }
// ============================================================
    //  [AI Core v9.0] Grand Master Edition (Bug Fixed)
    //  ìˆ˜ì •ì‚¬í•­: ì„±ë°° ë£¨í”„ í•´ê²°, í•¸ë“œ ì œí•œ ë¬´ì‹œ ê¸°ëŠ¥ íƒ‘ì¬
    // ============================================================

    aiTurn() {
        const ai = this.cp;
        // [ì•ˆì „ì¥ì¹˜] ì´ë¯¸ ê²Œì„ì´ ëë‚¬ê±°ë‚˜ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìœ¼ë©´ ì •ì§€
        if (this.isGameEnded || ai.time >= CONFIG.MAX_TIME) return;

        try {
            // 1. [í•¸ë“œ ì •ë¦¬ ìš°ì„ ] í„´ ì‹œì‘ ì‹œ í•¸ë“œê°€ 9ì¥ ì´ìƒì´ë©´ ì¦‰ì‹œ ì •ë¦¬ (ë²„ê·¸ ë°©ì§€)
            if (ai.getHandCount() > CONFIG.HAND_LIMIT) {
                this.aiSmartDiscard(ai, null);
                // ì •ë¦¬ í›„ ë”œë ˆì´ë¥¼ ë‘ê³  ì¬ì‹œì‘
                setTimeout(() => this.aiTurn(), 500); 
                return;
            }

            // 2. [ì „ìˆ ] ë¡œí‚¤ ì¹´ë“œ ì‚¬ìš© (ë¬´í•œë£¨í”„ ë°©ì§€ëœ ë²„ì „)
            if (this.aiCheckStrategicLoki()) {
                setTimeout(() => this.aiTurn(), 800);
                return;
            }

            // 3. [ì „ëµ] ëª©í‘œ ìˆ˜ë¦½
            const bestPlan = this.aiFindBestPlan();
            if (!bestPlan) throw new Error("ëª©í‘œ ì„¤ì • ì‹¤íŒ¨");
            
            ai.aiTargetIdx = bestPlan.targetIdx; 
            const targetArt = bestPlan.art;
this.aiTryCeltConvert(targetArt);

            // 4. [ì‹¤í–‰] í–‰ë™ ê²°ì •
            if (bestPlan.action === 'SWAP_ARTIFACT') {
                this.aiExecuteSwap(bestPlan.handIdx, bestPlan.reserveIdx, bestPlan.marketIdx);
                return;
            }

            if (bestPlan.action === 'CRAFT') {
                this.openCraftModal(bestPlan.targetIdx, bestPlan.fromReserve);
                
                if (bestPlan.discountType) {
                    const olympusLv = this.getArtLevel('olympus');
                    const amount = olympusLv >= 3 ? 12 : (olympusLv >= 2 ? 5 : 2);
                    this.setOlympusDiscount(bestPlan.discountType, amount);
                }
                
                this.aiAutoSelectMaterials(targetArt, bestPlan.discountType);
                
                // ìœ íš¨ì„± ê²€ì‚¬
                const statusCheck = this.validateCraft(targetArt, document.createElement('div'));
                if (!statusCheck.valid) {
                    this.closeCraftModal();
                    // ê³„ì‚°ë³´ë‹¤ ì‹¤ì œ ì¬ë£Œê°€ ë¶€ì¡±í•˜ë©´ ìì› í™•ë³´ë¡œ ì„ íšŒ
                    this.aiActionGather(bestPlan); 
                } else {
                    this.executeCraft();
                }
                return;
            }

            if (bestPlan.action === 'RESERVE') {
                if (ai.reserved.length >= 1) {
                    this.aiActionGather(bestPlan);
                } else {
                    this.openCraftModal(bestPlan.targetIdx, false);
                    this.confirmReserve();
                }
                return;
            }

            // ìì› í™•ë³´
            this.aiActionGather(bestPlan);

        } catch (e) {
            console.warn(`[AI Error P${ai.id}] ${e.message}`);
            console.error(e); // ìƒì„¸ ì—ëŸ¬ë¥¼ ì½˜ì†”ì— ì¶œë ¥
            
            // ë¹„ìƒ ì¡°ì¹˜ ì‹¤í–‰
            this.aiEmergencyAction();
            
            // [ì¤‘ìš”] ë¹„ìƒ ì¡°ì¹˜ í›„ì—ë„ ì‹œê°„ì´ ê·¸ëŒ€ë¡œë¼ë©´ ê°•ì œë¡œ 1ì‹œê°„ì„ íë¥´ê²Œ í•¨ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
            // ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ì£¼ì–´ ë¹„ìƒ ì¡°ì¹˜ ë‚´ì˜ ë“œë¡œìš° ë¡œì§ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ í•¨
            setTimeout(() => {
                if (this.cp.id === ai.id && this.cp.time === ai.time) {
                    this.addLog(`[System] AI P${ai.id} ì˜¤ë¥˜ ë³µêµ¬: ê°•ì œ í„´ ë„˜ê¹€`);
                    this.consumeTime(1);
                }
            }, 1000);
        }
    }

    // [ì „ìˆ ] ë¡œí‚¤ ì „ìˆ  (ì„±ë°° ë£¨í”„ í•´ê²°ë¨)
    aiCheckStrategicLoki() {
        const ai = this.cp;

        // 1. ê³„ìŠ¹ìì˜ ë¬¸ì¥
        const crestIdx = ai.hand.findIndex(c => c.cat === 'loki' && c.extra.type === 'instant_score');
        if (crestIdx !== -1) {
            this.addLog(`[AI] 'ê³„ìŠ¹ìì˜ ë¬¸ì¥' ë°œë™ (+2ì )`);
            this._aiForceUseLoki(crestIdx); // ê°•ì œ ì‚¬ìš© í•¨ìˆ˜ í˜¸ì¶œ
            return true;
        }

        // 2. ì‹œê³—ë°”ëŠ˜
        const clockIdx = ai.hand.findIndex(c => c.cat === 'loki' && c.extra.type === 'active_time');
        if (clockIdx !== -1) {
            if (ai.time >= 9 || (ai.score < 10 && ai.time >= 7)) {
                this.addLog(`[AI] ì‹œê°„ì„ ë˜ëŒë¦½ë‹ˆë‹¤ (-1H)`);
                this._aiForceUseLoki(clockIdx);
                return true;
            }
        }

        // 3. ê²€ì€ ì£¼ì‚¬ìœ„
        const diceIdx = ai.hand.findIndex(c => c.cat === 'loki' && c.extra.type === 'active_draw');
        if (diceIdx !== -1) {
            const junkCount = ai.hand.filter(c => c.cat === 'resource' && c.val <= 3).length;
            if (junkCount >= 3) {
                this.addLog(`[AI] íŒ¨ê°€ ë§ë ¤ 'ê²€ì€ ì£¼ì‚¬ìœ„' ì‚¬ìš©`);
                this._aiForceUseLoki(diceIdx);
                return true;
            }
        }

        // 4. ë¯¸ë˜ ì¼ê¸°
        const diaryIdx = ai.hand.findIndex(c => c.cat === 'loki' && c.extra.type === 'active_peek');
        if (diaryIdx !== -1 && ai.reserved.length === 0) {
            const hasGoodMarket = this.fieldArt.some(art => art.score >= 14);
            if (!hasGoodMarket) {
                this.addLog(`[AI] 'ë¯¸ë˜ ì¼ê¸°'ë¡œ ìœ ë¬¼ íƒìƒ‰`);
                // ë¡œí‚¤ ì¹´ë“œ ì œê±°
                ai.hand.splice(diaryIdx, 1);
                // ë¡œì§ ìˆ˜í–‰
                const cards = this.deckArt.peek(3);
                cards.sort((a,b) => b.score - a.score);
                if (cards.length > 0) {
                    ai.reserved.push(cards[0]);
                    this.deckArt.shuffle();
                    this.addLog(`[AI] ë¯¸ë˜ ì¼ê¸° ê²°ê³¼: [${cards[0].name}] íšë“`);
                }
                this.render();
                return true;
            }
        }
        
        // 5. í˜¼ëˆì˜ ì±„ì„ë§ì¹˜
        const hammerIdx = ai.hand.findIndex(c => c.cat === 'loki' && c.extra.type === 'active_reset');
        if (hammerIdx !== -1) {
             let maxVal = 0;
             this.fieldRes.forEach(c => { if(c.val > maxVal) maxVal = c.val; });
             if (maxVal <= 4) {
                 this.addLog(`[AI] ì‹œì¥ í’ˆì§ˆì´ ë‚®ì•„ 'í˜¼ëˆì˜ ì±„ì„ë§ì¹˜' ì‚¬ìš©`);
                 this._aiForceUseLoki(hammerIdx);
                 return true;
             }
        }

        return false;
    }

    // [New] AI ì „ìš© ë¡œí‚¤ ì‚¬ìš© í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ê°€ AIë¥¼ ì°¨ë‹¨í•˜ë¯€ë¡œ ë³„ë„ êµ¬í˜„)
    _aiForceUseLoki(idx) {
        const ai = this.cp;
        const card = ai.hand[idx];
        if (!card) return;

        const type = card.extra.type;
        
        // íš¨ê³¼ ì ìš©
        if (type === "instant_score") ai.score += 2;
        else if (type === "active_time") ai.time = Math.max(0, ai.time - 1);
        else if (type === "active_reset") {
            this.fieldRes.forEach(c => this.deckRes.discard(c)); 
            this.fieldRes.length = 0;
            this.fill('resource', this.getMarketSize('resource'));
        }
        else if (type === "active_reset_bless") {
            this.fieldBless.forEach(c => this.deckBless.discard(c)); 
            this.fieldBless.length = 0;
            this.fill('blessing', this.getMarketSize('blessing'));
        }
        else if (type === "active_draw") {
            // ìì› 2ê°œ ë²„ë¦¬ê³  2ê°œ ë½‘ê¸° (ë‹¨ìˆœí™”)
            let removed = 0;
            for(let i=ai.hand.length-1; i>=0; i--) {
                if(ai.hand[i].cat === 'resource' && removed < 2) {
                    this.deckRes.discard(ai.hand[i]);
                    ai.hand.splice(i, 1);
                    removed++;
                }
            }
            this.drawFromDeck('resource');
            this.drawFromDeck('resource');
        }

        // ì¹´ë“œ ì œê±° (í•µì‹¬: ì—¬ê¸°ì„œ í™•ì‹¤íˆ ì§€ì›Œì•¼ ë£¨í”„ê°€ ì•ˆ ë”)
        // ì£¼ì˜: active_draw ë“±ì—ì„œ ì¸ë±ìŠ¤ê°€ ë°€ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°ì²´ ë¹„êµë¡œ ì§€ì›€
        const realIdx = ai.hand.indexOf(card);
        if (realIdx !== -1) ai.hand.splice(realIdx, 1);
        
        this.render();
    }

    // [ì „ëµ] ëª©í‘œ ìˆ˜ë¦½
    aiFindBestPlan() {
        const ai = this.cp;
        let bestScore = -9999;
        let bestPlan = null;

        // ë§ê°ì˜ ì£¼íŒ ê°
        const abacusIdx = ai.hand.findIndex(c => c.cat === 'loki' && c.extra.type === 'active_swap');
        if (abacusIdx !== -1 && ai.reserved.length > 0 && this.fieldArt.length > 0) {
            let worstRes = { score: 999, idx: -1 };
            ai.reserved.forEach((art, i) => { if(art.score < worstRes.score) worstRes = {score: art.score, idx: i}; });
            let bestMkt = { score: -1, idx: -1 };
            this.fieldArt.forEach((art, i) => { if(art.score > bestMkt.score) bestMkt = {score: art.score, idx: i}; });
            
            if (bestMkt.score - worstRes.score >= 6) {
                return { action: 'SWAP_ARTIFACT', handIdx: abacusIdx, reserveIdx: worstRes.idx, marketIdx: bestMkt.idx };
            }
        }

        // ë³´ê´€í•¨ í‰ê°€
        ai.reserved.forEach((art, idx) => {
            const analysis = this.aiCalculateTargetValue(art, true);
            analysis.targetIdx = idx;
            if (analysis.netValue > bestScore) { bestScore = analysis.netValue; bestPlan = analysis; }
        });

        // ì‹œì¥ í‰ê°€
        this.fieldArt.forEach((art, idx) => {
            const analysis = this.aiCalculateTargetValue(art, false);
            analysis.targetIdx = idx;
            if (analysis.netValue > bestScore) { bestScore = analysis.netValue; bestPlan = analysis; }
        });

        return bestPlan;
    }

// ============================================================
    //  [AI Brain v9.2] ì œì‘ íŒë‹¨ ë° ì¬ë£Œ ì„ íƒ (Simulation & Auto-Select)
    // ============================================================

// [UPGRADED] ì¼ˆíŠ¸/ì˜¬ë¦¼í¬ìŠ¤/ë…¸ë¥´ë“œ ëŠ¥ë ¥ì„ ì™„ë²½í•˜ê²Œ ê³„ì‚°í•˜ëŠ” AI ë‘ë‡Œ
    aiCalculateTargetValue(art, isReserved) {
        const ai = this.cp;
        
        // 1. ê¸°ë³¸ ìì› íŒŒì•… (ë³´ìœ ëŸ‰)
        let myRes = { adamantite:0, mithril:0, dragonBone:0, starFragment:0 };
        
        ai.hand.forEach(c => {
            if (c.cat === 'resource') {
                let val = c.val;
                // í™©ì†Œìë¦¬ ë³´ë„ˆìŠ¤
                if(this.constellationMode && this.activeConstellation.type === 'passive_value_up' && c.type === this.taurusBonusType) val += 1;
                myRes[c.type] += val;
            }
            else if (c.cat === 'loki' && c.extra.type === 'res_split') {
                // ë¡œí‚¤ ìì› (ê³„ì‚° í¸ì˜ìƒ ì²« ë²ˆì§¸ ì˜µì…˜ìœ¼ë¡œ ê°€ì •)
                if (c.extra.mode === 'AND') c.extra.options.forEach(opt => myRes[opt.type] += opt.val);
                else myRes[c.extra.options[0].type] += c.extra.options[0].val;
            }
        });

        // 2. ì˜¬ë¦¼í¬ìŠ¤ í• ì¸ ì‹œë®¬ë ˆì´ì…˜ (ê°€ì¥ ì´ë“ì´ ë˜ëŠ” ìì›ì„ ìŠ¤ìŠ¤ë¡œ ì°¾ìŒ)
        const olympusLv = this.getArtLevel('olympus');
        let bestDiscountType = null;
        let discountAmt = 0;
        
        if (olympusLv > 0) {
            discountAmt = olympusLv >= 3 ? 12 : (olympusLv >= 2 ? 5 : 2);
            let maxSaved = -1;
            // ì–´ë–¤ ìì›ì„ í• ì¸ë°›ì•„ì•¼ ê°€ì¥ ë§ì´ ê¹ì´ëŠ”ì§€ ê³„ì‚°
            for (const [type, req] of Object.entries(art.cost)) {
                if (req > 0) {
                    const saved = Math.min(req, discountAmt);
                    if (saved > maxSaved) {
                        maxSaved = saved;
                        bestDiscountType = type;
                    }
                }
            }
        }

        // 3. ì¼ˆíŠ¸ ë³€í™˜ ì ì¬ë ¥ ê³„ì‚° (ë‚¨ì€ ë³€í™˜ íšŸìˆ˜)
        const celtLv = this.getArtLevel('celt');
        const maxSwaps = celtLv >= 3 ? 3 : (celtLv >= 2 ? 2 : (celtLv >= 1 ? 1 : 0));
        let remainingSwaps = Math.max(0, maxSwaps - ai.celtConvertCount);

        // 4. ë¶€ì¡±ë¶„ ê³„ì‚° (ë³€í™˜ ê°€ëŠ¥ì„± í¬í•¨)
        let missingTotalVal = 0;
        let needsSwap = false;
        
        for (const [type, req] of Object.entries(art.cost)) {
            let actualReq = req;
            // ìœ„ì—ì„œ ê³„ì‚°í•œ ìµœì ì˜ í• ì¸ì„ ì ìš©
            if (bestDiscountType === type) actualReq = Math.max(0, req - discountAmt);

            let currentVal = myRes[type] || 0;
            let needed = actualReq - currentVal;

            if (needed > 0) {
                // ë¶€ì¡±í•œë° ë³€í™˜ íšŸìˆ˜ê°€ ë‚¨ì•˜ë‹¤ë©´? -> "ë³€í™˜í•´ì„œ ë©”ê¿€ ìˆ˜ ìˆë‹¤"ê³  íŒë‹¨
                if (remainingSwaps > 0) {
                    // ì¹´ë“œ 1ì¥ë‹¹ í‰ê·  ê°€ì¹˜ 4ë¡œ ê°€ì •í•˜ì—¬ ì»¤ë²„ ê°€ëŠ¥í•œì§€ ê³„ì‚°
                    const potentialFill = remainingSwaps * 4; 
                    
                    if (needed <= potentialFill) {
                        // ë³€í™˜ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥! -> ë¶€ì¡±ë¶„ 0 ì²˜ë¦¬, íšŸìˆ˜ ì°¨ê° ì‹œë®¬ë ˆì´ì…˜
                        const swapsNeeded = Math.ceil(needed / 4);
                        remainingSwaps -= swapsNeeded;
                        needed = 0; 
                        needsSwap = true;
                    } else {
                        // ë³€í™˜í•´ë„ ë¶€ì¡±í•¨ -> ìµœëŒ€í•œ ë©”ê¾¸ê³  ë‚¨ì€ ë¶€ì¡±ë¶„ ê³„ì‚°
                        needed -= potentialFill;
                        remainingSwaps = 0;
                        missingTotalVal += needed;
                    }
                } else {
                    missingTotalVal += needed;
                }
            }
        }

        // 5. ê°€ì¹˜ ì‚°ì •
        let action = 'GATHER';
        let completionBonus = 0;
        
        // ë¶€ì¡±ë¶„ì´ 0ì´ë©´ (ë³€í™˜ í¬í•¨í•´ì„œ) ì œì‘ ê°€ëŠ¥!
        if (missingTotalVal <= 0) {
            action = 'CRAFT';
            completionBonus = 500; // ì œì‘ 1ìˆœìœ„
            if (needsSwap) completionBonus += 50; // ë³€í™˜ ëŠ¥ë ¥ ì ê·¹ í™œìš© ì¥ë ¤
        } else {
            // ì™„ì„±ì´ ê°€ê¹Œìš¸ìˆ˜ë¡ ì ìˆ˜ (ìµœëŒ€ 100ì )
            completionBonus = Math.max(0, 100 - (missingTotalVal * 5));
        }

        // 6. ë¹„ìš© ë° í„´ ê³„ì‚° (ë…¸ë¥´ë“œ ì†ë„ ë°˜ì˜)
        const nordLv = this.getArtLevel('nord');
        // ê¸°ë³¸: 3.5 / ë…¸ë¥´ë“œ1~2: 7.0 / ë…¸ë¥´ë“œ3: 10.5 (í„´ë‹¹ ìì› íšë“ ê¸°ëŒ€ê°’)
        let gatherSpeed = 3.5;
        if (nordLv >= 3) gatherSpeed = 10.5;
        else if (nordLv >= 1) gatherSpeed = 7.0;

        const gatherTurns = Math.ceil(missingTotalVal / gatherSpeed); 
        let totalTurnCost = gatherTurns * 5; 

        let netValue = (art.score * 0.5) + completionBonus - totalTurnCost;

        // ì¶•ë³µ ì²´í¬ (ë‹¨ìˆœí™”)
        const hasBless = ai.hand.some(c => 
            (c.cat === 'blessing' && c.type === art.type) || 
            (c.cat === 'loki' && c.extra.type === 'bless_split' && c.extra.tags.includes(art.type))
        );
        
        // ì¼ˆíŠ¸ 3ë ™(ì¶•ë³µ ë©´ì œ)ì´ ì•„ë‹ˆë©´ ì¶•ë³µ ì—†ì´ëŠ” ê°ì 
        if (celtLv < 3 && !hasBless) {
            netValue -= 200; 
        }

        return { 
            art, 
            netValue, 
            action, 
            fromReserve: isReserved, 
            discountType: bestDiscountType, // AIê°€ ìŠ¤ìŠ¤ë¡œ ê³„ì‚°í•œ ìµœì  í• ì¸ íƒ€ì… ë°˜í™˜
            needBless: (!hasBless && celtLv < 3), 
            missingVal: missingTotalVal 
        };
    }

    // [ì†] ì œì‘ ì¬ë£Œ ìë™ ì„ íƒ (ì´ í•¨ìˆ˜ê°€ ìˆì–´ì•¼ AIê°€ ì¹´ë“œë¥¼ ì„ íƒí•¨)
    aiAutoSelectMaterials(art, discountType) {
        this.craftSelection.clear();
        const ai = this.cp;
        
        // 1. ì¼ë‹¨ ëª¨ë“  ìì›ê³¼ ê´€ë ¨ ë¡œí‚¤ ì¹´ë“œë¥¼ ì„ íƒ (ê³¼ì‰ ì„ íƒí•´ë„ validateCraftì—ì„œ ì•Œì•„ì„œ ì²˜ë¦¬ë¨)
        ai.hand.forEach((c, i) => {
            // ìì›
            if (c.cat === 'resource') {
                this.craftSelection.add(i);
            }
            // ë¡œí‚¤: ì¬ë£Œí˜•(ìœµí•©ì„)
            else if (c.cat === 'loki' && c.extra.type === 'res_split') {
                this.craftSelection.add(i);
            }
            // ë¡œí‚¤: ë¬´ë£Œ ì œì‘(íšŒì¤‘ì‹œê³„)
            else if (c.cat === 'loki' && c.extra.type === 'passive_free') {
                this.craftSelection.add(i);
            }
            // ì¶•ë³µ: ì¼ì¹˜í•˜ëŠ” ì¶•ë³µ
            else if (c.cat === 'blessing' && c.type === art.type) {
                this.craftSelection.add(i);
            }
            // ë¡œí‚¤: ëŒ€ì²´ ì¶•ë³µ
            else if (c.cat === 'loki' && c.extra.type === 'bless_split' && c.extra.tags.includes(art.type)) {
                this.craftSelection.add(i);
            }
            // ì¼ˆíŠ¸ ì¶•ë³µ ëŒ€ì²´ (ì•„ë¬´ ì¶•ë³µì´ë‚˜ ì‚¬ìš©)
            else if (this.getArtLevel('celt') >= 2 && c.cat === 'blessing') {
                this.craftSelection.add(i);
            }
        });

        // UI ê°±ì‹  (ì„ íƒëœ ìƒíƒœ ë³´ì—¬ì£¼ê¸° - ì‹œê°ì  ë””ë²„ê¹…ìš©)
        this.renderCraftUI();
    }

// [FIX INTEGRATED] AI í†µí•© íŒ¨ì¹˜: ìì•„ ìƒì‹¤, ë± ê³ ê°ˆ, ë¡œì§ ì˜¤ë¥˜ ë™ì‹œ í•´ê²°

    // [FIX] AI ìì› í™•ë³´: í–‰ë™ ì£¼ì²´(ai)ë¥¼ ëª…í™•íˆ ì „ë‹¬í•˜ì—¬ ì˜¤ë¥˜ ë°©ì§€
    aiActionGather(plan) {
        const ai = this.cp; // í•¨ìˆ˜ ì‹œì‘ ì‹œì ì˜ í”Œë ˆì´ì–´(P2)ë¥¼ ê¸°ì–µ
        
        // 0. ì¶•ë³µ ì²˜ë¦¬
        if (plan.needBless) {
            const blessIdx = this.fieldBless.findIndex(c => c.type === plan.art.type);
            if (blessIdx !== -1) this._aiForceGetCard('blessing', blessIdx);
            else {
                const grailIdx = ai.hand.findIndex(c => c.cat === 'loki' && c.extra.type === 'active_reset_bless');
                if (grailIdx !== -1) {
                    this.addLog(`[AI] ì¶•ë³µ ë¦¬ì…‹ì„ ìœ„í•´ 'íŒŒê´´ëœ ì„±ë°°' ì‚¬ìš©`);
                    this._aiForceUseLoki(grailIdx);
                    setTimeout(() => this.aiTurn(), 800);
                    return;
                }
                this._aiForceDraw('blessing');
            }
            // [í•µì‹¬] í–‰ë™í•œ AI(ai ë³€ìˆ˜)ë¥¼ ì§ì ‘ ì „ë‹¬
            this.finalizeAIAction(ai, plan.art);
            return;
        }

        // 1. ë…¸ë¥´ë“œ ì½¤ë³´
        if (this.getArtLevel('nord') > 0 && this.aiTryNordAction(plan.art)) {
            return;
        }

        // 2. ìì› íƒìƒ‰ (ì§€ëŠ¥ ê°œì„ íŒ ì ìš©)
        let neededTypes = [];
        let myRes = {}; 
        ai.hand.forEach(c => { if(c.cat==='resource') myRes[c.type] = (myRes[c.type]||0)+c.val; });
        
        for(const [t, req] of Object.entries(plan.art.cost)) {
            if(myRes[t] < req) neededTypes.push(t);
        }

        let targetIdx = -1;
        // ìš°ì„ ìˆœìœ„ 1: í•„ìš”í•œ ìì› ì¤‘ ê³ ê°€ì¹˜(3 ì´ìƒ)
        for (let i = 0; i < this.fieldRes.length; i++) {
            if (neededTypes.includes(this.fieldRes[i].type) && this.fieldRes[i].val >= 3) {
                targetIdx = i; break;
            }
        }
        // ìš°ì„ ìˆœìœ„ 2: í•„ìš”í•œ ìì›ì´ë¼ë©´ ìˆ˜ì¹˜ê°€ ë‚®ì•„ë„(2) í™•ë³´ (ë©ˆì¶¤ ë°©ì§€)
        if (targetIdx === -1) {
            for (let i = 0; i < this.fieldRes.length; i++) {
                if (neededTypes.includes(this.fieldRes[i].type)) {
                    targetIdx = i; break;
                }
            }
        }
        // ìš°ì„ ìˆœìœ„ 3: ê³ ê°€ì¹˜(6 ì´ìƒ) ë²”ìš©
        if (targetIdx === -1) {
            for (let i = 0; i < this.fieldRes.length; i++) {
                if (this.fieldRes[i].val >= 6) { targetIdx = i; break; }
            }
        }
        // ìš°ì„ ìˆœìœ„ 4: ë³´í—˜ìš© ì¤‘ê°€ì¹˜(4 ì´ìƒ)
        if (targetIdx === -1) {
             for (let i = 0; i < this.fieldRes.length; i++) {
                if (this.fieldRes[i].val >= 4) { targetIdx = i; break; }
            }
        }

        if (targetIdx !== -1) this._aiForceGetCard('resource', targetIdx);
        else this._aiForceDraw('resource');

        // [í•µì‹¬] í–‰ë™í•œ AI(ai ë³€ìˆ˜)ë¥¼ ì§ì ‘ ì „ë‹¬
        this.finalizeAIAction(ai, plan.art);
    }

    // [New] AI ì „ìš© ìì› íšë“ í•¨ìˆ˜ (í•¸ë“œ ì œí•œ ë¬´ì‹œ)
    _aiForceGetCard(cat, idx) {
        const ai = this.cp;
        const list = cat === 'resource' ? this.fieldRes : this.fieldBless;
        const card = list[idx];
        const costKey = cat === 'resource' ? 'RES' : 'BLESS';
        const cost = this.getCost(costKey);

        const targetId = cat === 'resource' ? 'marketRes' : 'marketBless';
        const targetEl = document.querySelector(`#${targetId} > div:nth-child(${idx+1})`);

        this.addLog(`[P${ai.id}] ${cat==='resource' ? RES_NAMES[card.type] : 'ì¶•ë³µ'} íšë“`);
        
        this.animateAIAction(targetEl, () => {
            ai.hand.push(card);
            list.splice(idx, 1);
            this.consumeTime(cost);
            this.fill(cat, this.getMarketSize(cat));
            this.render();
        });
    }

    // [FIX] AI ê°•ì œ ë“œë¡œìš°: ë±ì´ ì—†ì„ ê²½ìš° ë©ˆì¶”ëŠ” ë²„ê·¸ ìˆ˜ì •
    _aiForceDraw(cat) {
        const ai = this.cp;
        const deck = cat === 'resource' ? this.deckRes : this.deckBless;
        const costKey = cat === 'resource' ? 'RES' : 'BLESS';
        const cost = this.getCost(costKey);
        
        const card = deck.draw();
        
        // [í•µì‹¬ ìˆ˜ì •] ë±ì´ ë¹„ì–´ì„œ ì¹´ë“œë¥¼ ëª» ë½‘ìœ¼ë©´, ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  ì‹œê°„ë§Œ ì†Œëª¨í•˜ì—¬ í„´ì„ ë„˜ê¹€
        if (!card) {
            this.addLog(`[AI P${ai.id}] ${cat} ë±ì´ ê³ ê°ˆë˜ì–´ í–‰ë™ì„ ì‰½ë‹ˆë‹¤.`);
            this.consumeTime(cost > 0 ? cost : 1); // 1ì‹œê°„ ê°•ì œ ì†Œëª¨
            return;
        }

        const deckId = cat === 'resource' ? 'deckRes' : 'deckBless';
        this.addLog(`[P${ai.id}] ${cat} ë± ë“œë¡œìš°`);

        this.animateAIAction(document.getElementById(deckId), () => {
            ai.hand.push(card);
            this.consumeTime(cost);
            this.render();
        });
    }

    // [FIX] AI í•¸ë“œ ì •ë¦¬: í˜„ì¬ í„´ì¸ AI(aiPlayer)ë¥¼ ëª…í™•íˆ ì§€ì •í•˜ì—¬ ì²˜ë¦¬
    finalizeAIAction(aiPlayer, targetArt) {
        // ê¸°ì¡´: const ai = this.cp; (ì´ë ‡ê²Œ í•˜ë©´ í„´ì´ ë„˜ì–´ê°„ ë’¤ ë‹¤ìŒ ì‚¬ëŒì„ ì¡ìŒ)
        // ë³€ê²½: ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì€ aiPlayer(í–‰ë™í•œ ë‹¹ì‚¬ì)ë¥¼ ì‚¬ìš©
        if (aiPlayer.getHandCount() > CONFIG.HAND_LIMIT) {
            this.aiSmartDiscard(aiPlayer, targetArt);
        }
    }

    aiSmartDiscard(ai, targetArt) {
        while (ai.getHandCount() > CONFIG.HAND_LIMIT) {
            let scores = ai.hand.map((c, i) => {
                let score = 0;
                if (c.cat === 'loki') score = 500;
                else if (targetArt) {
                    if (c.cat === 'blessing' && c.type === targetArt.type) score = 300;
                    else if (c.cat === 'resource' && targetArt.cost[c.type] > 0) score = 100 + (c.val * 10);
                }
                if (score === 0 && c.cat === 'resource' && c.val >= 6) score = 50;
                if (score === 0) {
                    if (c.cat === 'resource') score = c.val;
                    else score = 10;
                }
                return { idx: i, score: score };
            });

            scores.sort((a, b) => a.score - b.score);
            const worst = scores[0];
            const c = ai.hand[worst.idx];
            
            ai.hand.splice(worst.idx, 1);
            if (c.cat === 'resource') this.deckRes.discard(c);
            else if (c.cat === 'blessing') this.deckBless.discard(c);
            
            this.addLog(`[AI] í•¸ë“œ ì •ë¦¬: ${c.cat==='resource' ? c.val : 'ì¹´ë“œ'} ë²„ë¦¼`);
        }
        this.render();
    }

    aiEmergencyAction() {
        // ë©ˆì¶¤ ë°©ì§€ìš© ë¹„ìƒ íƒˆì¶œ
        const ai = this.cp;
        if (ai.hand.length > 0) ai.hand.shift(); // ì¹´ë“œ í•œ ì¥ ë²„ë¦¼
        this._aiForceDraw('resource'); // ê°•ì œ ë“œë¡œìš°
    }
    aiTryNordAction(targetArt) {
        const nordLv = this.getArtLevel('nord');
        const limitSum = nordLv >= 3 ? 14 : (nordLv >= 2 ? 9 : 6);
        const limitCount = nordLv >= 3 ? 3 : 2;
        let neededTypes = Object.keys(targetArt.cost);
        let indices = this.fieldRes.map((_, i) => i);
        let bestCombo = null; let bestScore = -1; 
        
        const evaluateCombo = (idxs) => {
            let sum = 0; let hasNeeded = false;
            for(let idx of idxs) { const c = this.fieldRes[idx]; sum += c.val; if (neededTypes.includes(c.type)) hasNeeded = true; }
            if (sum > limitSum) return -1; 
            let score = sum; if (hasNeeded) score += 20; return score;
        };
        
        // Simple combination logic (2 cards)
        for (let i = 0; i < indices.length; i++) {
            for (let j = i + 1; j < indices.length; j++) {
                const combo = [indices[i], indices[j]]; const evaluate = evaluateCombo(combo);
                if (evaluate > bestScore) { bestScore = evaluate; bestCombo = combo; }
            }
        }
        
        if (bestCombo && bestCombo.length >= 2) {
            if (this.cp.hand.length + bestCombo.length > CONFIG.HAND_LIMIT + 2) return false; 
            bestCombo.sort((a, b) => b - a);
            let logMsg = []; const firstCardIdx = bestCombo[0];
            const targetEl = document.querySelector(`#marketRes > div:nth-child(${firstCardIdx+1})`);
            
            this.animateAIAction(targetEl, () => {
                bestCombo.forEach(idx => {
                    const c = this.fieldRes[idx]; this.cp.hand.push(c); this.fieldRes.splice(idx, 1);
                    logMsg.push(`${RES_NAMES[c.type]}(${c.val})`);
                });
                const cost = this.getCost('RES'); this.consumeTime(cost);
                this.fill('resource', this.getMarketSize('resource')); this.render();
                this.addLog(`[AI] ë…¸ë¥´ë“œ ëŠ¥ë ¥ ë°œë™! (${logMsg.join(', ')})`);
            });
            return true; 
        }
        return false; 
    }addLog(msg) { const log = document.getElementById('gameLog'); const p = document.createElement('div'); p.innerText = msg; log.prepend(p); }
    addNightLog(msg) { const log = document.getElementById('nightLog'); const p = document.createElement('div'); p.innerText = msg; log.prepend(p); }
    
    fill(cat, max) {
        const field = cat === 'resource' ? this.fieldRes : (cat === 'blessing' ? this.fieldBless : this.fieldArt);
        const deck = cat === 'resource' ? this.deckRes : (cat === 'blessing' ? this.deckBless : this.deckArt);
        while(field.length < max) { const c = deck.draw(); if(c) field.push(c); else break; }
        
        // Libra Effect: Auto-reset market on 4 duplicates
        if (cat === 'resource' && this.constellationMode && this.activeConstellation.type === 'market_auto_reset') {
            const counts = {}; field.forEach(c => { counts[c.type] = (counts[c.type]||0) + 1; });
            const hasFour = Object.values(counts).some(cnt => cnt >= 4);
            if (hasFour) {
                this.addLog(`[ì²œì¹­ìë¦¬] ê°™ì€ ìì› 4ì¥ ê°ì§€! ì‹œì¥ì„ êµì²´í•©ë‹ˆë‹¤.`);
                field.forEach(c => deck.discard(c)); field.length = 0;
                while(field.length < max) { const c = deck.draw(); if(c) field.push(c); else break; }
            }
        }
    }

    getArtLevel(type) { 
        let count = this.cp.artifacts.filter(a => a.type === type).length;
        const celtCount = this.cp.artifacts.filter(a => a.type === 'celt').length;
        
        // [Bug Fix] Celt Mimic adds +1 level, not full count
        if (celtCount >= 3 && this.cp.celtMimicMode === type) { 
            count += 1; 
        }
        
        // Celt itself doesn't benefit from mimic
        if (type === 'celt' && celtCount >= 3 && this.cp.celtMimicMode !== null) { return 0; }
        
        return count;
    }

    getCost(action) {
        if (this.devMode) return 0;
        let cost = CONFIG.COST[action];
        const egyptLv = this.getArtLevel('egypt');
        if (action === 'RESERVE' && egyptLv >= 1) cost -= 1;
        if (action === 'RES' && egyptLv >= 2) cost -= 1;
        if ((action === 'BLESS' || action === 'ART') && egyptLv >= 3) cost -= 1;
        return Math.max(0, cost);
    }

    canAct(cost) {
        if (this.cp.id !== 1 && !this.devMode) return false;
        if (this.cp.time >= CONFIG.MAX_TIME) { alert("ì‹œê°„ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤."); return false; } 
        return true; 
    }

    checkHandFull(add=1) { 
        const cnt = this.cp.getHandCount();
        if(cnt + add > CONFIG.HAND_LIMIT + 1) { alert(`í•¸ë“œê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 9ì¥ê¹Œì§€ ì¼ì‹œ í—ˆìš©)\në¨¼ì € ì¹´ë“œë¥¼ ë²„ë ¤ì£¼ì„¸ìš”.`); return true; } 
        return false;
    }

    clickResourceCard(idx) { if (this.getArtLevel('nord') > 0) this.clickResource(idx); else this.getCard('resource', idx); }
    
    clickResource(idx) {
        if (this.cp.isAI) { this.getCard('resource', idx); return; }
        if (!this.cp.nordMode) { this.cp.nordMode = true; this.cp.nordSelected.clear(); }
        if (this.cp.nordSelected.has(idx)) this.cp.nordSelected.delete(idx); else this.cp.nordSelected.add(idx);
        this.render();
    }

    confirmNord() {
        const nordLv = this.getArtLevel('nord');
        const indices = Array.from(this.cp.nordSelected);
        const cards = indices.map(i => this.fieldRes[i]);
        const sum = cards.reduce((a, b) => a + b.val, 0); const count = cards.length;
        let limitSum = nordLv >= 3 ? 14 : (nordLv >= 2 ? 9 : 6); let limitCount = nordLv >= 3 ? 3 : 2;
        
        if (count > limitCount) { alert(`ìµœëŒ€ ${limitCount}ì¥ ê°€ëŠ¥`); return; }
        
        // [ìˆ˜ì •] 1ì¥ë§Œ ì„ íƒí•œ ê²½ìš°(ì¼ë°˜ êµ¬ë§¤)ëŠ” í•©ê³„ ì œí•œì„ ë¬´ì‹œí•¨
        if (count > 1 && sum > limitSum) { alert(`í•©ê³„ ${limitSum} ì´ˆê³¼ (1ì¥ë§Œ ì„ íƒ ì‹œ ì¼ë°˜ êµ¬ë§¤ ê°€ëŠ¥)`); return; }
        
        if (count === 0) return;
        
        const cost = this.getCost('RES');
        if (!this.devMode && !this.canAct(cost)) return;
        if (!this.devMode && this.checkHandFull(count)) return;
        
        indices.sort((a,b)=>b-a);
        indices.forEach(i => { this.cp.hand.push(this.fieldRes[i]); this.fieldRes.splice(i, 1); });
        this.consumeTime(cost);
        this.fill('resource', this.getMarketSize('resource'));
        this.cp.nordMode = false; this.cp.nordSelected.clear(); this.render();
    }
    
    cancelNord() { this.cp.nordMode = false; this.cp.nordSelected.clear(); this.render(); }

    getCard(cat, idx) {
        const costKey = cat === 'resource' ? 'RES' : 'BLESS';
        const cost = this.getCost(costKey);
        if (!this.devMode) { if (!this.cp.isAI && !this.canAct(cost)) return; if (this.checkHandFull()) return; }
        
        const list = cat === 'resource' ? this.fieldRes : this.fieldBless;
        const card = list[idx];
        
        if (this.cp.isAI) {
            const info = cat === 'resource' ? `${RES_NAMES[card.type]} (${card.val})` : `${TYPE_NAMES[card.type]} ì¶•ë³µ`;
            this.addLog(`[P${this.cp.id}] ì‹œì¥ì—ì„œ íšë“: ${info}`);
            const targetId = cat === 'resource' ? 'marketRes' : 'marketBless';
            const targetEl = document.querySelector(`#${targetId} > div:nth-child(${idx+1})`);
            this.animateAIAction(targetEl, () => {
                this.cp.hand.push(card); list.splice(idx, 1); this.consumeTime(cost);
                this.fill(cat, this.getMarketSize(cat)); this.render();
            });
            return;
        }
        
        this.cp.hand.push(card); list.splice(idx, 1);
        this.consumeTime(cost); this.fill(cat, this.getMarketSize(cat)); this.render();
    }

    drawFromDeck(cat) {
        if (!this.cp.isAI) audioManager.playSelect();
        const costKey = cat === 'resource' ? 'RES' : 'BLESS';
        const cost = this.getCost(costKey);
        if (!this.devMode && !this.cp.isAI) { if (!this.canAct(cost)) return; if (this.checkHandFull()) return; }
        
        const deck = cat === 'resource' ? this.deckRes : this.deckBless;
        if (this.cp.isAI) {
            const card = deck.draw(); if(!card) return;
            const deckId = cat === 'resource' ? 'deckRes' : 'deckBless';
            this.addLog(`[P${this.cp.id}] ${cat==='resource'?'ìì›':'ì¶•ë³µ'} ë±ì—ì„œ ë½‘ê¸°`);
            this.animateAIAction(document.getElementById(deckId), () => {
                this.cp.hand.push(card); this.consumeTime(cost); this.render();
            });
            return;
        }
        
        const card = deck.draw(); if (!card) { alert("ë± ì—†ìŒ!"); return; }
        this.cp.hand.push(card); this.consumeTime(cost); this.render();
    }

    reserveFromDeck() {
        if (this.cp.isAI) return;
        audioManager.playSelect();
        if (this.cp.reserved.length >= 1) { alert("ë³´ê´€í•¨ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."); return; }
        const cost = this.getCost('RESERVE');
        if (!this.devMode && !this.canAct(cost)) return;
        
        const card = this.deckArt.draw();
        if(!card) { alert("ìœ ë¬¼ ë±ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤."); return; }
        this.cp.reserved.push(card); this.consumeTime(cost); this.render();
    }

    swap(cat) {
        const cost = this.getCost('SWAP');
        if (!this.devMode && !this.canAct(cost)) return;
        
        const list = cat === 'resource' ? this.fieldRes : (cat === 'blessing' ? this.fieldBless : this.fieldArt);
        const deck = cat === 'resource' ? this.deckRes : (cat === 'blessing' ? this.deckBless : this.deckArt);
        
        list.forEach(c => deck.discard(c)); list.length = 0;
        this.fill(cat, this.getMarketSize(cat)); this.consumeTime(cost); this.render();
    }

    onHandCardClick(i) { this.discard(i); }
    
    discard(idx) {
        const c = this.cp.hand[idx]; if(!c) return; 
        // Handle Active Loki Items
        if (c.cat === 'loki' && c.extra.type.startsWith('active_')) { this.useLokiItem(idx); return; }
        
        if(!this.cp.isAI && !confirm("ì´ ì¹´ë“œë¥¼ ë²„ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        this.cp.hand.splice(idx, 1); 
        if(c.cat === 'resource') this.deckRes.discard(c); else if(c.cat === 'blessing') this.deckBless.discard(c); 
        this.render();
        if (!this.cp.isAI && this.cp.id === 1) { this.determineNextTurn(); }
    }

    useLokiItem(idx) { 
        if (this.cp.isAI) return; 
        const card = this.cp.hand[idx]; const type = card.extra.type;
        
        if (type.startsWith("passive_") || type.startsWith("bless_") || type.startsWith("res_")) { alert("ì œì‘ ì¬ë£Œìš©ì…ë‹ˆë‹¤."); return; }
        
      if (type === "active_swap") {
            if (this.cp.reserved.length === 0) { alert("ë³´ê´€ ì¤‘ì¸ ìœ ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            if (this.fieldArt.length === 0) { alert("êµí™˜í•  ì¤‘ì•™ ìœ ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            this.openSwapModal(idx); return; 
        }
        
        if (type === "active_peek") {
            if (this.deckArt.getCount() < 3) { alert("ìœ ë¬¼ ë±ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
            // [ìˆ˜ì •] ë¯¸ë˜ì¼ê¸°ëŠ” ë³´ê´€í•¨ ì œí•œì„ ë¬´ì‹œí•˜ê³  ë°œë™ (ì˜ˆì™¸ ì²˜ë¦¬)
            this.openFutureDiary(idx);
            return;
        }

        if(!confirm(`[${card.extra.name}] ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        let success = false;
        if (type === "active_time") { this.cp.time = Math.max(0, this.cp.time - 1); alert("ì‹œê°„ -1H"); success = true; }
        else if (type === "active_reset") { 
            // [ìˆ˜ì •] í˜¼ëˆì˜ ì±„ì„ë§ì¹˜: ì‹œê°„ ì†Œëª¨ ì—†ì´ ì¦‰ì‹œ êµì²´
            this.fieldRes.forEach(c => this.deckRes.discard(c)); this.fieldRes.length = 0;
            this.fill('resource', this.getMarketSize('resource')); 
            this.render();
            success = true; 
        }
        else if (type === "active_reset_bless") { 
            // [ìˆ˜ì •] íŒŒê´´ëœ ì„±ë°°: ì‹œê°„ ì†Œëª¨ ì—†ì´ ì¦‰ì‹œ êµì²´
            this.fieldBless.forEach(c => this.deckBless.discard(c)); this.fieldBless.length = 0;
            this.fill('blessing', this.getMarketSize('blessing'));
            this.render();
            success = true; 
        }
        else if (type === "active_draw") { 
            // Discard 2 resources, Draw 2
            const resIndices = this.cp.hand.map((c, i) => c.cat === 'resource' ? i : -1).filter(i => i !== -1);
            if (resIndices.length < 2) { alert("ë²„ë¦´ ìì› ì¹´ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
            // For simplicity in this patched version, just remove first 2 resources
            this.cp.hand.splice(resIndices[1], 1); 
            this.cp.hand.splice(resIndices[0], 1);
            this.drawFromDeck('resource'); this.drawFromDeck('resource');
            success = true; 
        } 
        
        if(success) { this.cp.hand.splice(idx, 1); this.render(); }
    }

    // --- Future Diary Logic ---
    openFutureDiary(handIdx) {
        this.futureDiaryState = { active: true, handIdx: handIdx };
        const cards = this.deckArt.peek(3);
        const listEl = document.getElementById('futureDiaryList'); listEl.innerHTML = '';
        cards.forEach((c, i) => {
             const div = document.createElement('div');
             div.className = `card artifact type-${c.type}`;
             div.innerHTML = `<div class="artifact-info"><div class="art-name">${c.name}</div><div class="art-score">â˜… ${c.score}</div></div>`;
             div.onclick = () => this.confirmFutureDiary(c);
             listEl.appendChild(div);
        });
        document.getElementById('futureDiaryModal').style.display = 'flex';
    }

    confirmFutureDiary(selectedCard) {
        this.cp.reserved.push(selectedCard);
        // Remove used card from hand
        this.cp.hand.splice(this.futureDiaryState.handIdx, 1);
        // Shuffle deck to simulate "putting others back" (Simplified)
        this.deckArt.shuffle();
        
        document.getElementById('futureDiaryModal').style.display = 'none';
        this.futureDiaryState = { active: false, handIdx: -1 };
        this.addLog("ë¯¸ë˜ ì¼ê¸°ë¡œ ìœ ë¬¼ì„ ë³´ê´€í–ˆìŠµë‹ˆë‹¤.");
        this.render();
    }

    openCraftModal(idx, fromReserve) {
        if (this.cp.isAI) return;
        if (!this.devMode && this.cp.time >= CONFIG.MAX_TIME) { alert("ì‹œê°„ ì´ˆê³¼!"); return; }
        
        this.selectedArtIdx = idx; 
        this.isWorkingFromReserve = fromReserve;
        
        // ì„ íƒ ì´ˆê¸°í™” (ë‹¨ìˆœí™”ë¨)
        this.craftSelection.clear(); 
        this.cp.olympusDiscount = { type: null, amount: 0 };
        
        const art = fromReserve ? this.cp.reserved[idx] : this.fieldArt[idx]; 
        if(!art) return;
        
        document.getElementById('craftModal').style.display = 'flex';
        
        // íƒ€ê²Ÿ ìœ ë¬¼ ì •ë³´ í‘œì‹œ
        const targetEl = document.getElementById('craftTargetCard');
        targetEl.innerHTML = `<div class="card artifact type-${art.type}"><div class="artifact-info"><div class="art-type badge-${art.type}" style="font-size:10px;">${TYPE_NAMES[art.type]}</div><div class="art-name">${art.name}</div><div class="art-score">â˜… ${art.score}</div></div></div>`;
        
        // ì˜¬ë¦¼í¬ìŠ¤ í• ì¸ ì˜µì…˜ í‘œì‹œ
        const olympusLv = this.getArtLevel('olympus'); 
        const olympusDiv = document.getElementById('olympusOption'); 
        const olympusRadios = document.getElementById('olympusRadios');
        olympusRadios.innerHTML = '';
        
        if (olympusLv > 0) {
            let discount = olympusLv >= 3 ? 12 : (olympusLv >= 2 ? 5 : 2);
            document.getElementById('olympusVal').innerText = discount; 
            olympusDiv.style.display = 'block';
            olympusRadios.innerHTML = `<label><input type="radio" name="olympus" value="none" checked onchange="game.setOlympusDiscount(null, 0)"> ì—†ìŒ</label>`;
            Object.keys(art.cost).forEach(resType => { 
                olympusRadios.innerHTML += `<label><input type="radio" name="olympus" value="${resType}" onchange="game.setOlympusDiscount('${resType}', ${discount})"> ${RES_NAMES[resType]}</label>`; 
            });
        } else { 
            olympusDiv.style.display = 'none'; 
        }
        
        // ë³´ê´€ ë²„íŠ¼ ì²˜ë¦¬
        const btnRes = document.getElementById('btnReserveInModal');
        if(fromReserve) {
            btnRes.style.display = 'none';
        } else {
            const cost = this.getCost('RESERVE'); 
            btnRes.style.display = 'inline-block';
            btnRes.disabled = (this.cp.reserved.length >= 1); 
            btnRes.innerText = btnRes.disabled ? "ê°€ë“ ì°¸" : `ğŸ“¦ ë³´ê´€ (${cost}H)`;
        }
        
        this.renderCraftUI();
    }

    // ì œì‘ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    closeCraftModal() { 
        document.getElementById('craftModal').style.display = 'none'; 
        this.craftSelection.clear(); 
    }
// [ìˆ˜ì •ëœ renderCraftUI: ì¼ˆíŠ¸ ë³€í™˜ ë²„íŠ¼ ë° ë³µì¡í•œ ë¡œì§ ì‚­ì œë¨]
    renderCraftUI() {
        // 1. DOM ì—˜ë¦¬ë¨¼íŠ¸ í™•ë³´
        const handGrid = document.getElementById('craftHandGrid');
        const paySlot = document.getElementById('paymentSlot');
        const statusEl = document.getElementById('craftStatus');
        
        handGrid.innerHTML = '';
        paySlot.innerHTML = '';

        // [ì‚­ì œë¨] ì¼ˆíŠ¸ ë³€í™˜ ëª¨ë“œ ë²„íŠ¼ ë¡œì§ ì œê±° (í”ì ê¸°ê´€ ì‚­ì œ ì™„ë£Œ)
        const oldBtn = document.getElementById('btnCeltToggle');
        if(oldBtn) oldBtn.remove();

        // 2. í˜„ì¬ ì œì‘ ëŒ€ìƒ ìœ ë¬¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        let artIdx = this.cp.isAI ? this.cp.aiTargetIdx : this.selectedArtIdx;
        if (artIdx === -1 || artIdx === null) return; 

        const targetArt = this.isWorkingFromReserve ? this.cp.reserved[artIdx] : this.fieldArt[artIdx];
        if (!targetArt) return;

        // 3. í•¸ë“œ ìˆœíšŒí•˜ë©° ì¹´ë“œ ë Œë”ë§
        this.cp.hand.forEach((c, i) => {
            const div = document.createElement('div');
            
            // ìŠ¤íƒ€ì¼ ë° í´ë˜ìŠ¤ ì •ì˜
            if (c.cat === 'loki') {
                div.className = 'card type-loki';
                div.setAttribute('data-tooltip', `${c.extra.name}\n${c.extra.desc}`);
            } else {
                div.className = `card type-${c.type}`;
            }
            
            div.style.backgroundImage = `url('${c.getImagePath()}')`;
            div.style.width = '60px';
            div.style.height = '87px';
            div.style.cursor = 'pointer';
            
            // [ë‹¨ìˆœí™”] í´ë¦­ ì´ë²¤íŠ¸: ë‹¨ìˆœíˆ ì„ íƒ/í•´ì œë§Œ ìˆ˜í–‰
            div.onclick = () => {
                audioManager.playSelect();
                if (this.craftSelection.has(i)) {
                    this.craftSelection.delete(i);
                } else {
                    this.craftSelection.add(i);
                }
                this.renderCraftUI(); // ì¬ë Œë”ë§
            };

            // 4. ì„ íƒ ìƒíƒœì— ë”°ë¥¸ ìœ„ì¹˜ ë¶„ê¸° (ì§€ë¶ˆ ìŠ¬ë¡¯ vs ë‚´ í•¸ë“œ)
            const isPaySelected = this.craftSelection.has(i);

            if (isPaySelected) {
                // ì„ íƒëœ ì¹´ë“œëŠ” ì§€ë¶ˆ ìŠ¬ë¡¯ìœ¼ë¡œ ì´ë™ (ì´ˆë¡ìƒ‰ í…Œë‘ë¦¬)
                div.style.border = "2px solid #00e676"; 
                div.style.boxShadow = "0 0 5px #00e676";
                paySlot.appendChild(div);
            } else {
                // ì„ íƒë˜ì§€ ì•Šì€ ì¹´ë“œëŠ” í•¸ë“œ ê·¸ë¦¬ë“œì— ìœ ì§€
                handGrid.appendChild(div);
            }
        });

        // 5. ì‹¤ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬ ë° ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        this.validateCraft(targetArt, statusEl);
    }

// [ìˆ˜ì •] ë§ê°ì˜ ì£¼íŒ: êµí™˜ ëª¨ë‹¬ ì—´ê¸° (ì•ˆì „ì„± ê°•í™”)
    openSwapModal(handIdx) {
        console.log("ë§ê°ì˜ ì£¼íŒ ëª¨ë‹¬ ì—´ë¦¼. ì‚¬ìš©í•œ í•¸ë“œ ì¹´ë“œ ì¸ë±ìŠ¤:", handIdx);
        this.swapState = { handIdx: handIdx, reserveIdx: -1, marketIdx: -1 };
        
        const myDiv = document.getElementById('swapMyReserved');
        const marketDiv = document.getElementById('swapMarket');
        const btn = document.getElementById('btnExecuteSwap');
        
        // ì´ˆê¸°í™”: ë²„íŠ¼ ë¹„í™œì„±í™” ë° ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
        btn.disabled = true;
        btn.classList.add('disabled'); // ì‹œê°ì  ë¹„í™œì„±í™” í™•ì‹¤í•˜ê²Œ ì²˜ë¦¬
        myDiv.innerHTML = '';
        marketDiv.innerHTML = '';

        // ë‚´ ë³´ê´€í•¨ ë Œë”ë§
        this.cp.reserved.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = `card artifact type-${c.type} card-scale-down`;
            div.innerHTML = `<div class="artifact-info"><div class="art-name">${c.name}</div><div class="art-score">â˜…${c.score}</div></div>`;
            div.onclick = () => this.selectSwapCard('reserve', i);
            div.id = `swap-res-${i}`;
            div.style.cursor = 'pointer'; // í´ë¦­ ê°€ëŠ¥ í‘œì‹œ
            myDiv.appendChild(div);
        });

        // ì‹œì¥ ìœ ë¬¼ ë Œë”ë§
        this.fieldArt.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = `card artifact type-${c.type} card-scale-down`;
            div.innerHTML = `<div class="artifact-info"><div class="art-name">${c.name}</div><div class="art-score">â˜…${c.score}</div></div>`;
            div.onclick = () => this.selectSwapCard('market', i);
            div.id = `swap-mkt-${i}`;
            div.style.cursor = 'pointer'; // í´ë¦­ ê°€ëŠ¥ í‘œì‹œ
            marketDiv.appendChild(div);
        });

        document.getElementById('swapModal').style.display = 'flex';
    }

    // [ìˆ˜ì •] êµí™˜ ì¹´ë“œ ì„ íƒ ì²˜ë¦¬ (ì„ íƒ ì‹œê°íš¨ê³¼ ë° ë²„íŠ¼ í™œì„±í™” ì²´í¬)
    selectSwapCard(target, idx) {
        audioManager.playSelect(); // ì„ íƒìŒ ì¬ìƒ

        if (target === 'reserve') {
            this.swapState.reserveIdx = idx;
            // UI í•˜ì´ë¼ì´íŠ¸ (ê¸°ì¡´ ì„ íƒ ì œê±° í›„ ìƒˆ ì„ íƒ ì ìš©)
            const list = document.getElementById('swapMyReserved').children;
            Array.from(list).forEach(el => el.classList.remove('swap-select')); // Array.fromìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ìˆœíšŒ
            
            const targetEl = document.getElementById(`swap-res-${idx}`);
            if(targetEl) targetEl.classList.add('swap-select');
        } else {
            this.swapState.marketIdx = idx;
            // UI í•˜ì´ë¼ì´íŠ¸
            const list = document.getElementById('swapMarket').children;
            Array.from(list).forEach(el => el.classList.remove('swap-target'));
            
            const targetEl = document.getElementById(`swap-mkt-${idx}`);
            if(targetEl) targetEl.classList.add('swap-target');
        }

        // ë‘˜ ë‹¤ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        const btn = document.getElementById('btnExecuteSwap');
        const isReady = (this.swapState.reserveIdx !== -1 && this.swapState.marketIdx !== -1);
        
        btn.disabled = !isReady;
        if(isReady) {
            btn.classList.remove('disabled');
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        } else {
            btn.classList.add('disabled');
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        }
    }

    // [ìˆ˜ì •] êµí™˜ ì‹¤í–‰ (ì‹¤ì œ ë°ì´í„° êµí™˜ ë° ë¡œê·¸ ì¶œë ¥)
    executeSwap() {
        if (this.swapState.reserveIdx === -1 || this.swapState.marketIdx === -1) {
            alert("ë³´ê´€í•¨ê³¼ ì‹œì¥ì—ì„œ ê°ê° ì¹´ë“œë¥¼ 1ì¥ì”© ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }
        
        const resIdx = this.swapState.reserveIdx;
        const mktIdx = this.swapState.marketIdx;
        const handIdx = this.swapState.handIdx;
        
        // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
        if (!this.cp.reserved[resIdx] || !this.fieldArt[mktIdx]) {
            alert("êµí™˜ ëŒ€ìƒ ì¹´ë“œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        // 1. ë°ì´í„° êµí™˜ (ë³´ê´€í•¨ <-> ì‹œì¥)
        const temp = this.cp.reserved[resIdx];
        this.cp.reserved[resIdx] = this.fieldArt[mktIdx];
        this.fieldArt[mktIdx] = temp;
        
        // 2. ë§ê°ì˜ ì£¼íŒ(ë¡œí‚¤ ì¹´ë“œ) ì†Œëª¨
        // ì£¼ì˜: ì¹´ë“œë¥¼ ì‚¬ìš©í•˜ê³  ì•„ì§ ë²„ë¦¬ì§€ ì•Šì€ ìƒíƒœì´ë¯€ë¡œ, ì—¬ê¸°ì„œ ë²„ë¦¼ ì²˜ë¦¬
        if (this.cp.hand[handIdx]) {
            const usedCard = this.cp.hand[handIdx];
            this.cp.hand.splice(handIdx, 1);
            // ë¡œí‚¤ ë±ìœ¼ë¡œ ë²„ë¦¬ì§€ ì•Šê³  ê²Œì„ì—ì„œ ì œì™¸í•˜ê±°ë‚˜ ë±ìœ¼ë¡œ ëŒë ¤ë³´ëƒ„ (ì—¬ê¸°ì„  ë‹¨ìˆœ ì œê±°)
            this.addLog(`[ë§ê°ì˜ ì£¼íŒ] ì‚¬ìš© ì™„ë£Œ: ${usedCard.extra.name}`);
        }
        
        this.addLog(`[êµí™˜] ë³´ê´€í•¨[${temp.name}] â†” ì‹œì¥[${this.cp.reserved[resIdx].name}]`);
        
        alert("ğŸ”„ êµí™˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        
        this.closeSwapModal();
        this.render();
    }
    closeSwapModal() {
        document.getElementById('swapModal').style.display = 'none';
        this.swapState = { handIdx: -1, reserveIdx: -1, marketIdx: -1 };
    }
    // ì œì‘ ì¬ë£Œ ì¹´ë“œ ì„ íƒ/í•´ì œ í† ê¸€ í•¨ìˆ˜
    toggleCraftCard(handIdx) { 
        if(this.craftSelection.has(handIdx)) this.craftSelection.delete(handIdx); 
        else this.craftSelection.add(handIdx); 
        this.renderCraftUI(); 
    }

// [FIXED] ë¡œí‚¤ ì¹´ë“œ(OR)ì˜ ìœ ë™ì  ê³„ì‚° ë¡œì§ ë³µêµ¬
    validateCraft(art, statusEl) {
        if (this.devMode) { 
            statusEl.innerHTML = `<div class="status-ok">ğŸ› ï¸ ê°œë°œì ëª¨ë“œ</div>`; 
            return { valid: true, isGrace: false, useFree: true }; 
        }

        const payCards = Array.from(this.craftSelection).map(i => this.cp.hand[i]);
        let valid = true; let isGrace = true; let msg = "";

        // íšŒì¤‘ì‹œê³„ ì²´í¬
        const hasFreeCard = payCards.some(c => c.cat === 'loki' && c.extra.type === 'passive_free');

        // í•©ê³„ ê³„ì‚°ì„ ìœ„í•œ ë³€ìˆ˜
        let currentSums = { adamantite:0, mithril:0, dragonBone:0, starFragment:0 };
        let flexibleLoki = []; // ì„ íƒí˜•(OR) ë¡œí‚¤ ì¹´ë“œëŠ” ë”°ë¡œ ë¹¼ë‘ 

        // 1. ê³ ì • ìˆ˜ì¹˜ ë¨¼ì € í•©ì‚°
        payCards.forEach(c => {
            if (c.cat === 'resource') {
                let val = c.val;
                // í™©ì†Œìë¦¬
                if(this.constellationMode && this.activeConstellation.type === 'passive_value_up' && c.type === this.taurusBonusType) val += 1;
                currentSums[c.type] += val;
            } else if (c.cat === 'loki' && c.extra.type === 'res_split') {
                if (c.extra.mode === 'AND') {
                    // ê³ ì •í˜•(AND)ì€ ì¦‰ì‹œ í•©ì‚°
                    c.extra.options.forEach(opt => currentSums[opt.type] += opt.val);
                } else {
                    // ì„ íƒí˜•(OR)ì€ ë‚˜ì¤‘ì— ê³„ì‚°í•˜ê¸° ìœ„í•´ ë³´ë¥˜
                    flexibleLoki.push(c.extra.options);
                }
            }
        });

        // 2. ì„ íƒí˜• ë¡œí‚¤ ì¹´ë“œ ìµœì  ë¶„ë°° (ë¶€ì¡±í•œ ê³³ì„ ì±„ìš°ë„ë¡)
        flexibleLoki.forEach(options => {
            let applied = false;
            // ì˜µì…˜ë“¤ì„ ìˆœíšŒí•˜ë©° ë¶€ì¡±í•œ ìì›ì´ ìˆë‹¤ë©´ ê±°ê¸°ì— íˆ¬ì…
            for(let opt of options) {
                let req = art.cost[opt.type] || 0;
                // ì˜¬ë¦¼í¬ìŠ¤ í• ì¸ ê³ ë ¤
                if (this.cp.olympusDiscount.type === opt.type) req = Math.max(0, req - this.cp.olympusDiscount.amount);
                
                if (currentSums[opt.type] < req) {
                    currentSums[opt.type] += opt.val;
                    applied = true;
                    break; // í•œ ê³³ì— ì“°ë©´ ë
                }
            }
            // ë¶€ì¡±í•œ ê³³ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì²« ë²ˆì§¸ì— ë”í•¨ (ì–´ì°¨í”¼ ì¶©ì¡±)
            if (!applied) {
                currentSums[options[0].type] += options[0].val;
            }
        });

        // 3. ìµœì¢… ìš”êµ¬ëŸ‰ ë¹„êµ
        for(const [resType, originalReq] of Object.entries(art.cost)) {
            let req = originalReq;
            // ì˜¬ë¦¼í¬ìŠ¤ í• ì¸
            if (this.cp.olympusDiscount.type === resType) req = Math.max(0, req - this.cp.olympusDiscount.amount);
            
            let val = currentSums[resType] || 0;
            let statusText = (val >= req) ? "ì¶©ì¡±" : "ë¶€ì¡±";
            if (val < req) valid = false;
            if (val > req) isGrace = false; 

            msg += `<div>${RES_NAMES[resType]}: ${val}/${req} ${statusText}</div>`;
        }

        // 4. ì¶•ë³µ ì²´í¬
        const celtLv = this.getArtLevel('celt');
        if (celtLv >= 3) {
            msg += `<div class="status-ok">ì¼ˆíŠ¸: ì¶•ë³µ ë©´ì œ</div>`;
        } else {
            const hasBless = payCards.some(c => 
                (c.cat === 'blessing' && c.type === art.type) || 
                (c.cat === 'loki' && c.extra.type === 'bless_split' && c.extra.tags.includes(art.type))
            );
            if(!hasBless) { msg += `<div class="status-fail">ì¶•ë³µ í•„ìš”</div>`; valid = false; }
            else { msg += `<div class="status-ok">ì¶•ë³µ í™•ì¸</div>`; }
        }

        if(valid && isGrace) msg += "âœ¨ ì€ì´!";
        statusEl.innerHTML = msg;
        return { valid, isGrace, useFree: hasFreeCard };
    }
  

  // [ë®ì–´ì“°ê¸°] ë‹¨ìˆœí™”ëœ ì œì‘ ì‹¤í–‰ í•¨ìˆ˜
    executeCraft() {
        try {
            let artIdx = this.cp.isAI ? this.cp.aiTargetIdx : this.selectedArtIdx;
            if (this.cp.isAI && artIdx === null) artIdx = this.selectedArtIdx;
            const art = this.isWorkingFromReserve ? this.cp.reserved[artIdx] : this.fieldArt[artIdx]; 
            
            const result = this.validateCraft(art, document.createElement('div'));
            if (!result.valid) { alert("ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }

            const indices = Array.from(this.craftSelection).sort((a,b) => b - a);
            
            // ì „ê°ˆìë¦¬ í™˜ê¸‰ ë¡œì§
            let scorpioRefundIdx = -1; let minVal = 999;
            if (this.constellationMode && this.activeConstellation.type === 'craft_refund' && result.isGrace) {
                 indices.forEach(idx => { const c = this.cp.hand[idx]; if (c.cat === 'resource' && c.val < minVal) { minVal = c.val; scorpioRefundIdx = idx; } });
            }

            indices.forEach(i => {
                if (i === scorpioRefundIdx) {
                     const c = this.cp.hand[i];
                     if(!this.cp.isAI) alert(`[ì „ê°ˆìë¦¬] ìì›(${c.val}) í™˜ê¸‰!`);
                } else {
                    const c = this.cp.hand[i];
                    this.cp.hand.splice(i, 1);
                    if(c.cat==='resource') this.deckRes.discard(c);
                    else if(c.cat==='blessing') this.deckBless.discard(c);
                }
            });

            this.craftSelection.clear();
            this.finalizeCraft(art, artIdx, result);

        } catch (e) { console.error(e); }
    }
 // [FIX] ì œì‘ ì™„ë£Œ ì²˜ë¦¬: ë¬´ë£Œ ì œì‘ ì‹œì—ë„ í„´ ê³„ì‚°ì´ ë˜ë„ë¡ ìˆ˜ì •
    finalizeCraft(art, artIdx, result) {
        let bonus = 0; 
        if(result.isGrace) { 
            if(art.score >= 24) bonus = 4; 
            else if(art.score >= 10) bonus = 3; 
            else bonus = 2; 
        }
        
        const craftedArt = { ...art, isGrace: result.isGrace, finalScore: art.score + bonus, bonus: bonus };
        this.cp.artifacts.push(craftedArt); 
        this.cp.score += craftedArt.finalScore;
        
        // ì¹´ë“œ ì œê±° ì²˜ë¦¬
        if (this.isWorkingFromReserve) this.cp.reserved.splice(artIdx, 1); 
        else { this.fieldArt.splice(artIdx, 1); this.fill('artifact', 7); }
        
        const cost = this.getCost('ART'); 
        
        // [í•µì‹¬ ìˆ˜ì •] ë¬´ë£Œ(íšŒì¤‘ì‹œê³„)ë¼ë„ 0ì‹œê°„ì„ ì†Œëª¨ì‹œì¼œ 'determineNextTurn'ì„ íŠ¸ë¦¬ê±°í•¨
        if (result.useFree) {
            this.addLog(`[P${this.cp.id}] 'ë¶€ì„œì§„ íšŒì¤‘ì‹œê³„'ë¡œ ì‹œê°„ ì†Œëª¨ ì—†ì´ ì œì‘!`);
            this.consumeTime(0); 
        } else {
            this.consumeTime(cost);
        }

        this.closeCraftModal(); 
        this.render();
        
        const log = `[P${this.cp.id}] "${craftedArt.name}" ì œì‘ ì„±ê³µ! (+${craftedArt.finalScore}ì ${result.isGrace?'/ì€ì´':' '})`;
        if(this.cp.isAI) this.addLog(log);
    }
// [FIX] ëˆ„ë½ëœ AI êµí™˜ ë¡œì§ ì¶”ê°€ (ë§ê°ì˜ ì£¼íŒ)
    aiExecuteSwap(handIdx, reserveIdx, marketIdx) {
        const ai = this.cp;
        
        // ìœ íš¨ì„± ê²€ì‚¬
        if (!ai.reserved[reserveIdx] || !this.fieldArt[marketIdx]) {
            this.aiEmergencyAction(); // ëŒ€ìƒì´ ì‚¬ë¼ì¡Œìœ¼ë©´ ë¹„ìƒ íƒˆì¶œ
            return;
        }

        const myArt = ai.reserved[reserveIdx];
        const marketArt = this.fieldArt[marketIdx];

        // êµí™˜ ì‹¤í–‰
        ai.reserved[reserveIdx] = marketArt;
        this.fieldArt[marketIdx] = myArt;

        // ë¡œí‚¤ ì¹´ë“œ ì†Œëª¨
        const usedCard = ai.hand[handIdx];
        if (usedCard) {
            ai.hand.splice(handIdx, 1);
            this.addLog(`[AI P${ai.id}] 'ë§ê°ì˜ ì£¼íŒ' ì‚¬ìš©: [${myArt.name}] â†” [${marketArt.name}]`);
        }

        // ì‹œê°„ ì†Œëª¨ (êµí™˜ì€ 1H)
        this.consumeTime(this.getCost('SWAP'));
        this.render();
    }

    // [FIX] ëˆ„ë½ëœ ì˜¬ë¦¼í¬ìŠ¤ í• ì¸ ì„¤ì • í•¨ìˆ˜ ì¶”ê°€
    setOlympusDiscount(type, amount) {
        if (!type) {
            this.cp.olympusDiscount = { type: null, amount: 0 };
        } else {
            this.cp.olympusDiscount = { type: type, amount: amount };
        }
        // ëª¨ë‹¬ì´ ì—´ë ¤ìˆë‹¤ë©´ UI ê°±ì‹ 
        if (document.getElementById('craftModal').style.display === 'flex') {
            this.renderCraftUI();
        }
    }
// [FIX] ë³´ê´€ ì‹¤í–‰: AIê°€ ë³´ê´€í•¨ì´ ê½‰ ì°¼ì„ ë•Œ ë©ˆì¶”ì§€ ì•Šê³  ìì› í™•ë³´ë¡œ ì„ íšŒí•˜ë„ë¡ ìˆ˜ì •
    confirmReserve() {
        // [ì•ˆì „ì¥ì¹˜] ë³´ê´€í•¨ í•œë„ ì²´í¬
        if (this.cp.reserved.length >= 1) {
            if (this.cp.isAI) {
                this.addLog(`[AI P${this.cp.id}] ë³´ê´€í•¨ì´ ê°€ë“ ì°¨ ê³„íšì„ ë³€ê²½í•©ë‹ˆë‹¤.`);
                // ë©ˆì¶”ì§€ ì•Šê³  ì¦‰ì‹œ ìì› í™•ë³´ í–‰ë™ìœ¼ë¡œ ìš°íšŒ
                // (null ì²´í¬ë¥¼ ìœ„í•´ aiTargetIdxê°€ ì—†ìœ¼ë©´ í˜„ì¬ ì„ íƒëœ ì¸ë±ìŠ¤ ì‚¬ìš©)
                let artIdx = this.cp.aiTargetIdx !== null ? this.cp.aiTargetIdx : this.selectedArtIdx;
                if(this.fieldArt[artIdx]) {
                    // ê°€ìƒì˜ ê³„íš ê°ì²´ë¥¼ ë§Œë“¤ì–´ ìì› í™•ë³´ë¡œ ë„˜ê¹€
                    this.aiActionGather({ art: this.fieldArt[artIdx], needBless: false });
                } else {
                    // ëŒ€ìƒë§ˆì € ì—†ìœ¼ë©´ ë¹„ìƒ íƒˆì¶œ
                    this.aiEmergencyAction();
                }
                return;
            } else {
                alert("ë³´ê´€í•¨ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
                return;
            }
        }

        let artIdx = this.cp.isAI ? this.cp.aiTargetIdx : this.selectedArtIdx;
        if (this.cp.isAI && artIdx === null) artIdx = this.selectedArtIdx;
        
        // ëŒ€ìƒ ìœ íš¨ì„± ê²€ì‚¬
        if (!this.fieldArt[artIdx]) {
             if (this.cp.isAI) { this.aiEmergencyAction(); return; }
             return;
        }

        const cost = this.getCost('RESERVE');
        if (!this.cp.isAI && !this.canAct(cost)) return;
        
        const art = this.fieldArt[artIdx];

        if (this.cp.isAI) {
            const targetEl = document.querySelector(`#marketArt > div:nth-child(${artIdx+1})`);
            this.addLog(`[P${this.cp.id}] "${art.name}" ë³´ê´€í•¨ìœ¼ë¡œ ì´ë™`);
            
            this.animateAIAction(targetEl, () => {
                this.cp.reserved.push(art);
                this.fieldArt.splice(artIdx, 1);
                this.consumeTime(cost); // ì´ì§‘íŠ¸ 1ë‹¨ê³„ë©´ 0ì‹œê°„ ì†Œëª¨ (ì •ìƒ ì‘ë™)
                
                this.fill('artifact', 7);
                this.closeCraftModal();
                this.render();
                this.cp.aiTargetIdx = null;
            });
            return;
        }
        
        audioManager.playSelect();
        this.cp.reserved.push(art);
        this.fieldArt.splice(artIdx, 1);
        this.consumeTime(cost);
        this.fill('artifact', 7);
        this.closeCraftModal();
        this.render();
    }
    getMedalType(score) { if(score >= 24) return 'Gold'; if(score >= 10) return 'Silver'; return 'Bronze'; }
    
    initMap() {
        const track = document.getElementById('mapTiles'); track.innerHTML = '';
        const radius = 100; const centerX = 140; const centerY = 140; 
        for(let i=0; i<12; i++) {
            const div = document.createElement('div'); const angle = (i / 12) * 2 * Math.PI - (Math.PI / 2);
            div.className = 'map-tile' + (i===0 ? ' key-time start-point' : ''); div.innerText = i === 0 ? "12/0" : i;
            const x = centerX + radius * Math.cos(angle); const y = centerY + radius * Math.sin(angle);
            div.style.left = `${x}px`; div.style.top = `${y}px`; track.appendChild(div);
        }
        this.updateTimeUI();
    }
    
    updateTimeUI() {
        const radius = 100; const centerX = 140; const centerY = 140;
        this.players.forEach(p => {
            const piece = document.getElementById(`pieceP${p.id}`);
            const effectiveTime = Math.min(p.time, 12); const displayTime = effectiveTime % 12;
            const angle = (displayTime / 12) * 2 * Math.PI - (Math.PI / 2);
            let x = centerX + radius * Math.cos(angle); let y = centerY + radius * Math.sin(angle);
            const stackOffset = 6; x += p.stackOrder * stackOffset; y -= p.stackOrder * stackOffset;
            piece.style.left = `${x}px`; piece.style.top = `${y}px`; piece.style.zIndex = 100 + p.stackOrder;
            if(p.id === this.cp.id) piece.classList.add('active-turn'); else piece.classList.remove('active-turn');
        });
    }

   startNightPhase() { 
        // [ìˆ˜ì •] ì²˜ë…€ìë¦¬: ì˜¤ë²„íƒ€ì„(12H ì´ˆê³¼)ì´ ì—†ëŠ” ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ +2ì 
        if (this.constellationMode && this.activeConstellation.type === 'day_end_score') {
            this.players.forEach(p => {
                // ì‹œê°„ì´ MAX_TIME(12) ì´í•˜ì¸ ê²½ìš°ë§Œ ë³´ìƒ
                if (p.time <= CONFIG.MAX_TIME) {
                    p.score += 2; 
                    this.addNightLog(`[ì²˜ë…€ìë¦¬] P${p.id} ì˜¤ë²„íƒ€ì„ ì—†ìŒ ë³´ë„ˆìŠ¤ +2ì `); 
                }
            });
        }
        document.getElementById('nightScreen').style.display = "flex"; document.getElementById('nightLog').innerHTML = ""; 
        document.getElementById('btnRevealLoki').style.display = 'none'; document.getElementById('btnEndNight').style.display = 'none';
        this.renderNightStatus();
        this.lokiOffers = []; for(let i=0; i<6; i++) { this.lokiOffers.push(this.deckLoki.draw()); }
        this.nightSelections = {}; 
        const marketEl = document.getElementById('lokiMarket'); marketEl.innerHTML = '';
        for(let i=1; i<=6; i++) {
            const c = this.lokiOffers[i-1];
            const div = document.createElement('div'); div.className = 'loki-slot';
            div.onmouseenter = () => audioManager.playHover();
            div.innerHTML = `<div class="loki-slot-num">${i}</div>`; div.id = `lokiSlot-${i}`;
            div.onclick = () => { 
                audioManager.playSelect(); 
                this.onLokiSlotClick(i); 
            };
            if(c) { div.style.backgroundImage = `url('${c.getImagePath()}')`; div.setAttribute('data-tooltip', `${c.extra.name}\n${c.extra.desc}`); } 
            else { div.innerHTML += `<span style="color:#555; margin:auto;">í’ˆì ˆ</span>`; }
            marketEl.appendChild(div);
        }
        this.addNightLog("ì›í•˜ëŠ” ì¹´ë“œë¥¼ ì„ íƒí•˜ê³  [ê²°ê³¼ ê³µê°œ]ë¥¼ ëˆ„ë¥´ì„¸ìš”.");
    }
    
    renderNightStatus() {
        const handEl = document.getElementById('nightHand'); const artEl = document.getElementById('nightArtifacts');
        handEl.innerHTML = ''; artEl.innerHTML = '';
        if (this.players[0].hand.length === 0) handEl.innerHTML = "<span style='color:#777; font-size:12px;'>ì—†ìŒ</span>";
        else {
            this.players[0].hand.forEach(c => {
                 const div = document.createElement('div'); div.className = c.cat==='loki' ? 'card type-loki' : `card type-${c.type}`;
                 div.style.backgroundImage = `url('${c.getImagePath()}')`; div.style.width = '50px'; div.style.height = '72px'; handEl.appendChild(div);
            });
        }
        if (this.players[0].artifacts.length === 0) artEl.innerHTML = "<span style='color:#777; font-size:12px;'>ì—†ìŒ</span>";
        else {
            this.players[0].artifacts.forEach(art => {
                 const div = document.createElement('div'); div.className = `card artifact type-${art.type} card-scale-down`;
                 div.style.width='50px'; div.style.height='72px';
                 div.innerHTML = `<div class="art-name" style="font-size:8px;">${art.name}</div><div class="art-score" style="font-size:9px;">â˜…${art.finalScore}</div>`;
                 artEl.appendChild(div);
            });
        }
    }
    
    onLokiSlotClick(num) {
        this.nightSelections[1] = num;
        for(let i=1; i<=6; i++) { document.getElementById(`lokiSlot-${i}`).classList.remove('selected'); }
        document.getElementById(`lokiSlot-${num}`).classList.add('selected');
        document.getElementById('btnRevealLoki').style.display = 'inline-block';
    }
    
    revealLokiResults() {
        document.getElementById('btnRevealLoki').style.display = 'none';
        [2, 3, 4].forEach(pid => { this.nightSelections[pid] = Math.floor(Math.random() * 6) + 1; });
        let counts = {}; Object.values(this.nightSelections).forEach(slot => { counts[slot] = (counts[slot] || 0) + 1; });
        let logs = []; let conflictSlots = new Set();
        for (const [slot, count] of Object.entries(counts)) {
            if (count > 1) { conflictSlots.add(parseInt(slot)); const slotEl = document.getElementById(`lokiSlot-${slot}`); if(slotEl) slotEl.classList.add('conflict'); }
        }
        this.players.forEach(p => {
            const choice = this.nightSelections[p.id]; const item = this.lokiOffers[choice-1];
            const slotEl = document.getElementById(`lokiSlot-${choice}`);
            if(slotEl) { const badge = document.createElement('span'); badge.className = 'loki-result-badge'; badge.innerText += `P${p.id} `; slotEl.appendChild(badge); }
            if (conflictSlots.has(choice)) { logs.push(`[P${p.id}] ${choice}ë²ˆ ì„ íƒ -> ğŸ’¥ì¶©ëŒ! íšë“ ì‹¤íŒ¨`); } 
            else if (item) {
                logs.push(`[P${p.id}] ${choice}ë²ˆ ì„ íƒ -> íšë“! [${item.extra.name}]`);
                if(item.extra.type === 'instant_score') p.score += 2; else p.hand.push(item);
                this.lokiOffers[choice-1] = null; 
            }
        });
        logs.forEach(msg => this.addNightLog(msg));
        document.getElementById('btnEndNight').style.display = 'inline-block';
    }

    finishNight() { 
        document.getElementById('nightScreen').style.display = "none"; 
        // 3ì¼ì°¨ ë°¤ì´ ëë‚  ë•Œ ì„ì‹œ ìœ ë¬¼ íšŒìˆ˜
        if (this.constellationMode && this.activeConstellation.type === 'temporary_artifact' && this.day === 3) {
            this.players.forEach(p => {
                // isTemp ì†ì„±ì´ ìˆëŠ” ìœ ë¬¼ì„ ì°¾ìŒ
                const idx = p.artifacts.findIndex(a => a.isTemp);
                if (idx !== -1) {
                    const removedArt = p.artifacts.splice(idx, 1)[0];
                    if (p.id === 1) { // í”Œë ˆì´ì–´ì—ê²Œë§Œ ì•Œë¦¼
                        alert(`[ì—¼ì†Œìë¦¬ ê¸°ê°„ ì¢…ë£Œ]\nëŒ€ì—¬í–ˆë˜ ìœ ë¬¼ [${removedArt.name}]ì´(ê°€) íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                }
            });
        }
        // [New] Game End Check
        if (this.day >= CONFIG.MAX_DAYS) {
            this.endGame();
            return;
        }

        this.day++;
        if (this.constellationMode && this.activeConstellation.type === 'daily_gift') {
            const rewardDay = this.day; 
            this.players.forEach(p => {
                let gift = null; let msg = "";
                if (rewardDay === 2) { gift = this.deckBless.draw(); msg = "ì¶•ë³µ"; }
                else if (rewardDay === 3) { gift = this.deckRes.draw(); msg = "ìì›"; }
                else if (rewardDay === 4) { gift = this.deckLoki.draw(); msg = "ë¹„ë°€ê±°ë˜"; }
                if (gift) { p.hand.push(gift); if(p.id===1) alert(`[ë±€ì£¼ì¸ìë¦¬] ${this.day}ì¼ì°¨ ì•„ì¹¨ ì„ ë¬¼: ${msg} ì¹´ë“œ íšë“`); }
            });
        }
        this.fieldRes.forEach(c => this.deckRes.discard(c)); this.fieldRes = [];
        this.fieldBless.forEach(c => this.deckBless.discard(c)); this.fieldBless = [];
        this.fill('resource', this.getMarketSize('resource')); this.fill('blessing', this.getMarketSize('blessing'));
        this.players.forEach(p => { p.time = Math.max(0, p.time - CONFIG.MAX_TIME); });
        this.render(); this.determineNextTurn();
    }

  // [FIX] ê²Œì„ ì¢…ë£Œ ë° ìµœì¢… ì ìˆ˜ ê³„ì‚° (ë³´ë„ˆìŠ¤ ê·œì¹™ ì¶”ê°€ë¨)
    endGame() {
        this.isGameEnded = true;
        audioManager.pauseBgm();
        // audioManager.playVictory(); // ìŠ¹ë¦¬ BGM ìˆë‹¤ë©´ ì¬ìƒ
        
        const container = document.getElementById('rankingContainer');
        container.innerHTML = '';

        // 1. [NEW] ì¶”ê°€ ì ìˆ˜ ê³„ì‚° ë¡œì§ ì ìš©
        this.players.forEach(p => {
            const counts = { olympus: 0, egypt: 0, nord: 0, celt: 0 };
            p.artifacts.forEach(art => {
                if (counts[art.type] !== undefined) counts[art.type]++;
            });

            let bonusScore = 0;
            let bonusTexts = [];

            // ê·œì¹™ 1: 4ì¢…ë¥˜ ì‹ í™” ëª¨ë‘ ë³´ìœ  ì‹œ +5ì  (ì‹ í™” í†µí•©)
            if (counts.olympus > 0 && counts.egypt > 0 && counts.nord > 0 && counts.celt > 0) {
                bonusScore += 5;
                bonusTexts.push("ğŸŒˆì‹ í™” í†µí•©(+5)");
            }

            // ê·œì¹™ 2: í•œ ì¢…ë¥˜ 4ì¥ ì´ìƒ ì‹œ, 3ì¥ ì´ˆê³¼ë¶„ë§ˆë‹¤ +2ì  (ì‹ í™” ì „ë¬¸í™”)
            for (const [type, count] of Object.entries(counts)) {
                if (count >= 4) {
                    const extraPoints = (count - 3) * 2;
                    bonusScore += extraPoints;
                    bonusTexts.push(`${TYPE_NAMES[type]} ì¥ì¸(+${extraPoints})`);
                }
            }

            // ì ìˆ˜ í•©ì‚° ë° ë¡œê·¸ ì €ì¥
            if (bonusScore > 0) {
                p.score += bonusScore;
                p.bonusDesc = bonusTexts.join(', ');
                this.addLog(`[ì¢…ë£Œ] Player ${p.id} ë³´ë„ˆìŠ¤ ì ìˆ˜ +${bonusScore} (${p.bonusDesc})`);
            } else {
                p.bonusDesc = "";
            }
        });

        // 2. ìˆœìœ„ ì •ë ¬ (ì ìˆ˜ -> ìœ ë¬¼ ìˆ˜ -> ê³¨ë“œ ë“±ê¸‰ ìˆ˜)
        const sorted = [...this.players].sort((a,b) => {
            if (b.score !== a.score) return b.score - a.score;
            if (b.artifacts.length !== a.artifacts.length) return b.artifacts.length - a.artifacts.length;
            const bGold = b.artifacts.filter(x=>x.grade==='Gold').length;
            const aGold = a.artifacts.filter(x=>x.grade==='Gold').length;
            return bGold - aGold;
        });

        // 3. ê²°ê³¼ í™”ë©´ ë Œë”ë§
        sorted.forEach((p, i) => {
            const row = document.createElement('div');
            row.className = `rank-row rank-p${p.id}`;
            
            // 1ë“±ì—ê²ŒëŠ” ì™•ê´€ ì•„ì´ì½˜
            const rankIcon = i === 0 ? "ğŸ‘‘ " : "";
            
            // ë³´ë„ˆìŠ¤ ë‚´ì—­ì´ ìˆìœ¼ë©´ ì‘ê²Œ í‘œì‹œ
            const bonusHtml = p.bonusDesc ? `<div style="font-size:11px; color:#f1c40f; margin-top:3px;">â”” ${p.bonusDesc}</div>` : "";

            row.innerHTML = `
                <span class="rank-num">${rankIcon}${i+1}</span>
                <span style="flex:1; font-weight:bold;">Player ${p.id}</span>
                <div style="text-align:right;">
                    <span style="font-size:20px; font-weight:bold; color:#fff;">${p.score}ì </span>
                    <div style="font-size:12px; color:#aaa;">ìœ ë¬¼ ${p.artifacts.length}ê°œ</div>
                    ${bonusHtml}
                </div>
            `;
            container.appendChild(row);
        });

        document.getElementById('gameEndModal').style.display = 'flex';
    }
} 

const game = new Game();

// [ìµœì í™”] ì „ì—­ íˆ´íŒ ì œì–´ ë¡œì§ (requestAnimationFrame ì ìš©)
const tooltipEl = document.getElementById('global-tooltip');
let isTooltipVisible = false;
let rafId = null; // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ID

document.addEventListener('mouseover', (e) => {
    const target = e.target.closest('[data-tooltip]');
    if (target) {
        const text = target.getAttribute('data-tooltip');
        if (text) {
            tooltipEl.innerText = text;
            tooltipEl.style.display = 'block';
            isTooltipVisible = true;
            // ì´ˆê¸° ìœ„ì¹˜ ì¡ê¸°
            updateTooltipPosition(e.clientX, e.clientY);
        }
    }
});

document.addEventListener('mousemove', (e) => {
    if (!isTooltipVisible) return;

    // ë¸Œë¼ìš°ì €ê°€ ë‹¤ìŒ í™”ë©´ì„ ê·¸ë¦´ ì¤€ë¹„ê°€ ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰ (ë ‰ ë°©ì§€ í•µì‹¬)
    if (rafId) return; 
    
    rafId = requestAnimationFrame(() => {
        updateTooltipPosition(e.clientX, e.clientY);
        rafId = null;
    });
});

document.addEventListener('mouseout', (e) => {
    const target = e.target.closest('[data-tooltip]');
    if (target) {
        tooltipEl.style.display = 'none';
        isTooltipVisible = false;
        if (rafId) {
            cancelAnimationFrame(rafId);
            rafId = null;
        }
    }
});

// ìœ„ì¹˜ ê³„ì‚° ë¡œì§ ë¶„ë¦¬
function updateTooltipPosition(x, y) {
    let left = x + 15;
    let top = y + 15;

    // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ê²ƒ ë°©ì§€
    if (left + 220 > window.innerWidth) left = x - 225;
    if (top + 100 > window.innerHeight) top = y - 100;

    // í•˜ë“œì›¨ì–´ ê°€ì† ì‚¬ìš© (transform) -> ë¶€ë“œëŸ¬ì›€ í–¥ìƒ
    tooltipEl.style.left = left + 'px';
    tooltipEl.style.top = top + 'px';
}

// [ì¶”ê°€] ìŠ¤í¬ë¡¤ ì‹œ íˆ´íŒ ì”ìƒ ë°©ì§€
window.addEventListener('scroll', () => {
    if (isTooltipVisible) {
        tooltipEl.style.display = 'none'; // ìŠ¤í¬ë¡¤ ì¤‘ì—” ìˆ¨ê¹€
        isTooltipVisible = false;
    }
}, { passive: true });
</script>
</body>
</html>